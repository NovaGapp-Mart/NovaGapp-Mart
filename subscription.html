<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Plans | NOVAGAPP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="public-config.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="global.js"></script>
<script>
  window.supa = window.supa || window.novaCreateSupabaseClient();
</script>

<style>
:root{
  --orange:#ff7a00;
  --bg:#0d0f14;
  --card:#151925;
}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:#fff;
}
.header{
  background:var(--orange);
  padding:16px;
  font-size:20px;
  font-weight:800;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:24px;
}
.plan{
  background:var(--card);
  border-radius:16px;
  padding:26px;
  box-shadow:0 15px 40px rgba(0,0,0,.5);
  position:relative;
}
.price{font-size:32px;font-weight:900}
button{
  width:100%;
  padding:14px;
  margin-top:18px;
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:800;
  cursor:pointer;
}
.buy{background:var(--orange);color:#000}
.current{background:#333;color:#aaa}
.badge{
  position:absolute;
  top:-12px;right:-12px;
  background:var(--orange);
  color:#000;
  padding:6px 12px;
  border-radius:10px;
  font-size:12px;
  font-weight:900;
}
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9977276800228616"
     crossorigin="anonymous"></script>
</head>

<body>

<div class="header">Plans</div>

<div class="container">

<!-- FREE -->
<div class="plan" id="plan-free">
  <h3>FREE</h3>
  <div class="price"><span class="money" data-money="0" data-currency="USD">$0</span></div>
  <ul>
    <li>2 previews / day</li>
    <li>Normal speed</li>
  </ul>
  <button class="current">Default</button>
</div>

<!-- PRO -->
<div class="plan" id="plan-pro">
  <h3>PRO</h3>
  <div class="price"><span class="money" data-money="40" data-currency="USD">$40</span> / month</div>
  <ul>
    <li>20 previews / day</li>
    <li>Fast processing</li>
    <li>Analytics</li>
  </ul>
  <button class="buy" onclick="pay(40,'PRO','USD')">Upgrade</button>
</div>

<!-- ENTERPRISE -->
<div class="plan enterprise" id="plan-enterprise">
  <div class="badge">MOST RECOMMENDED</div>
  <h3>ENTERPRISE</h3>
  <div class="price"><span class="money" data-money="4000" data-currency="USD">$4000</span> / month</div>
  <ul>
    <li>Unlimited previews</li>
    <li>Branding off</li>
    <li>Priority queue</li>
  </ul>
  <button class="buy" onclick="pay(4000,'ENTERPRISE','USD')">Upgrade</button>
</div>

</div>

<script>
const supaClient = window.supa;
if(!supaClient){
  alert("Supabase connection unavailable. Please refresh.");
  location.href = "login.html";
  throw new Error("supabase_client_unavailable");
}
let currentUser = null;
let activePlan = "FREE";
let razorpayKeyId = String(window.NOVA_PUBLIC_CONFIG?.razorpayKeyId || "").trim();
let paymentBusy = false;

function normalizeDesktopPlan(planInput){
  const raw = String(planInput || "").trim().toUpperCase();
  const digits = raw.replace(/[^0-9]/g, "");
  if(
    raw === "ENTERPRISE" ||
    raw === "BUSINESS" ||
    raw === "BUSINESS_999" ||
    raw === "ENTERPRISE_4000" ||
    digits === "4000"
  ){
    return "ENTERPRISE";
  }
  if(
    raw === "PRO" ||
    raw === "PLUS" ||
    raw === "CREATOR" ||
    raw === "PLUS_99" ||
    raw === "CREATOR_299" ||
    raw === "PRO_40" ||
    digits === "40"
  ){
    return "PRO";
  }
  return "FREE";
}

function getBackendPlanCode(planInput){
  const normalized = normalizeDesktopPlan(planInput);
  if(normalized === "ENTERPRISE") return "4000";
  if(normalized === "PRO") return "40";
  return "free";
}

function extractMissingColumnName(error){
  const text = `${error?.message || ""} ${error?.details || ""}`;
  const pgMatch = text.match(/column\s+\"?([a-zA-Z0-9_.]+)\"?\s+does not exist/i);
  if(pgMatch && pgMatch[1]){
    return String(pgMatch[1]).split(".").pop().toLowerCase();
  }
  const quotedMatch = text.match(/'([a-zA-Z0-9_]+)'/);
  if(quotedMatch && quotedMatch[1]){
    return String(quotedMatch[1]).toLowerCase();
  }
  return "";
}

/* ======================
   AUTH + CURRENT PLAN
====================== */
(async ()=>{
  const { data } = await supaClient.auth.getUser();
  if(!data?.user){
    alert("Login required");
    location.href="login.html";
    return;
  }
  currentUser = data.user;
  await Promise.all([loadPlan(), loadRazorpayConfig()]);
  markCurrent();
})();

async function loadPlan(){
  let query = supaClient
    .from("subscription")
    .select("plan")
    .eq("user_id", currentUser.id)
    .order("created_at",{ascending:false})
    .limit(1)
    .maybeSingle();

  let { data, error } = await query;
  if(error && missingColumnError(error)){
    query = supaClient
      .from("subscription")
      .select("plan")
      .eq("user_id", currentUser.id)
      .limit(1)
      .maybeSingle();
    ({ data, error } = await query);
  }

  if(error){
    console.error("subscription_load_plan_failed", error);
    return;
  }
  if(data?.plan){
    activePlan = normalizeDesktopPlan(data.plan);
  }
}

function markCurrent(){
  document.querySelectorAll(".plan").forEach(p=>{
    const btn = p.querySelector("button");
    if(!btn) return;
    btn.disabled=false;
    btn.className="buy";
    if(p.id === "plan-" + activePlan.toLowerCase()){
      btn.innerText="Current";
      btn.className="current";
      btn.disabled=true;
    }
  });
}

function setPaymentButtonsBusy(state){
  document.querySelectorAll(".plan .buy").forEach(btn=>{
    btn.disabled = !!state;
  });
}

async function loadRazorpayConfig(){
  try{
    const res = await fetch("/api/payment/config", { cache:"no-store" });
    const payload = await res.json().catch(()=>null);
    if(res.ok && payload?.ok && payload?.ready && payload?.key_id){
      razorpayKeyId = String(payload.key_id || "").trim();
      return true;
    }
  }catch(_){}
  return !!razorpayKeyId;
}

function missingColumnError(error){
  const msg = String(error?.message || "").toLowerCase();
  const details = String(error?.details || "").toLowerCase();
  const all = `${msg} ${details}`;
  return all.includes("column") && all.includes("does not exist");
}

function convertPlanAmountToInr(amount, currency){
  const baseAmount = Number(amount || 0);
  if(!Number.isFinite(baseAmount) || baseAmount <= 0){
    throw new Error("Invalid plan amount.");
  }
  const baseCurrency = String(currency || "INR").trim().toUpperCase() || "INR";
  if(baseCurrency === "INR"){
    return Math.round(baseAmount * 100) / 100;
  }
  if(typeof window.convertCurrency !== "function"){
    throw new Error("Currency conversion is unavailable.");
  }
  const converted = Number(window.convertCurrency(baseAmount, baseCurrency, "INR"));
  if(!Number.isFinite(converted) || converted <= 0){
    throw new Error("Unable to convert plan amount to INR.");
  }
  return Math.round(converted * 100) / 100;
}

async function createPaymentOrder(amountInr, plan, baseAmount, baseCurrency){
  const amountPaise = Math.round(Number(amountInr || 0) * 100);
  const cleanPlan = String(plan || "FREE").toUpperCase();
  const receipt = `sub_${cleanPlan.toLowerCase()}_${Date.now()}`;
  const name = String(
    currentUser?.user_metadata?.full_name ||
    currentUser?.user_metadata?.name ||
    currentUser?.email ||
    "User"
  );

  const res = await fetch("/api/payment/razorpay/order", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      amount_paise: amountPaise,
      currency: "INR",
      order_id: receipt,
      receipt,
      user_id: currentUser?.id || "",
      user_name: name,
      notes: {
        plan: cleanPlan,
        source: "subscription_page",
        base_amount: String(Number(baseAmount || 0)),
        base_currency: String(baseCurrency || "INR").toUpperCase()
      }
    })
  });
  const payload = await res.json().catch(()=>null);
  if(!res.ok || !payload?.ok || !payload?.order?.razorpay_order_id){
    const message = payload?.message || payload?.error || "Unable to create payment order.";
    throw new Error(String(message));
  }
  return payload.order;
}

async function verifyPayment(razorpayResponse){
  const res = await fetch("/api/payment/razorpay/verify", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      razorpay_order_id: razorpayResponse?.razorpay_order_id || "",
      razorpay_payment_id: razorpayResponse?.razorpay_payment_id || "",
      razorpay_signature: razorpayResponse?.razorpay_signature || ""
    })
  });
  const payload = await res.json().catch(()=>null);
  if(!res.ok || !payload?.ok || !payload?.verified){
    const message = payload?.message || payload?.error || "Payment verification failed.";
    throw new Error(String(message));
  }
  return payload;
}

async function saveSubscription(plan, amountInr, verifyPayload){
  const payload = {
    user_id: currentUser.id,
    plan: normalizeDesktopPlan(plan),
    amount: Number(amountInr || 0),
    currency: "INR",
    payment_id: String(verifyPayload?.razorpay_payment_id || ""),
    status: "active",
    razorpay_order_id: String(verifyPayload?.razorpay_order_id || "")
  };

  let row = { ...payload };
  let attempts = 0;
  while(attempts < 8){
    const { error } = await supaClient.from("subscription").insert(row);
    if(!error){
      try{
        localStorage.setItem("userPlan", getBackendPlanCode(payload.plan));
      }catch(_){}
      return;
    }
    if(!missingColumnError(error)){
      throw error;
    }
    const missingCol = extractMissingColumnName(error);
    if(!missingCol || !Object.prototype.hasOwnProperty.call(row, missingCol)){
      throw error;
    }
    delete row[missingCol];
    attempts += 1;
  }
  throw new Error("subscription_insert_failed");
}

async function openCheckout(order, amountInr, plan){
  if(typeof window.Razorpay !== "function"){
    throw new Error("Razorpay SDK failed to load.");
  }
  return new Promise((resolve, reject) => {
    let settled = false;
    const finish = (fn, value) => {
      if(settled) return;
      settled = true;
      fn(value);
    };
    const rzp = new window.Razorpay({
      key: String(order?.key_id || razorpayKeyId || ""),
      amount: Number(order?.amount_paise || Math.round(amountInr * 100)),
      currency: "INR",
      order_id: String(order?.razorpay_order_id || ""),
      name: "NOVAGAPP",
      description: `${String(plan || "FREE").toUpperCase()} Subscription`,
      prefill: {
        email: String(currentUser?.email || ""),
        name: String(
          currentUser?.user_metadata?.full_name ||
          currentUser?.user_metadata?.name ||
          ""
        )
      },
      handler: function(response){
        finish(resolve, response || {});
      },
      modal: {
        ondismiss: function(){
          finish(reject, new Error("Payment cancelled."));
        }
      }
    });
    rzp.on("payment.failed", function(event){
      const desc = event?.error?.description || "Payment failed. Please try again.";
      finish(reject, new Error(String(desc)));
    });
    rzp.open();
  });
}

/* ======================
   PAYMENT (RAZORPAY)
====================== */
async function pay(amount, plan, currency){
  if(!currentUser){
    alert("Login required");
    location.href = "login.html";
    return;
  }
  const nextPlan = normalizeDesktopPlan(plan);
  if(activePlan === nextPlan){
    alert("This plan is already active.");
    return;
  }
  if(paymentBusy){
    return;
  }
  paymentBusy = true;
  setPaymentButtonsBusy(true);

  try{
    const ready = await loadRazorpayConfig();
    if(!ready || !String(razorpayKeyId || "").trim()){
      throw new Error("Razorpay is not configured on server.");
    }

    const baseAmount = Number(amount || 0);
    const baseCurrency = String(currency || "INR").trim().toUpperCase() || "INR";
    const amountInr = convertPlanAmountToInr(baseAmount, baseCurrency);

    const order = await createPaymentOrder(amountInr, nextPlan, baseAmount, baseCurrency);
    const response = await openCheckout(order, amountInr, nextPlan);
    const verified = await verifyPayment(response);
    await saveSubscription(nextPlan, amountInr, verified);

    activePlan = nextPlan;
    markCurrent();
    alert("Plan activated");
  }catch(err){
    const message = String(err?.message || "Payment failed. Please try again.");
    if(message !== "Payment cancelled."){
      alert(message);
    }
  }finally{
    paymentBusy = false;
    setPaymentButtonsBusy(false);
    markCurrent();
  }
}
</script>

</body>
</html>

