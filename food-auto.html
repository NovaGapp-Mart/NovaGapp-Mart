<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, viewport-fit=cover">
<title>Food/Auto - NovaGapp Mart</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="global.js"></script>
<script src="public-config.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:#f5f5f5;
    padding-bottom:90px;
  }
  .top{
    background:#ff6a00;
    color:#fff;
    padding:12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-weight:700;
  }
  .section{
    background:#fff;
    margin:10px;
    border-radius:12px;
    padding:12px;
    box-shadow:0 4px 14px rgba(0,0,0,.06);
  }
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{
    border:none;
    border-radius:10px;
    padding:10px 12px;
    background:#111;
    color:#fff;
    cursor:pointer;
  }
  .btn.orange{background:#ff6a00}
  .chip{
    border:none;
    border-radius:999px;
    padding:7px 12px;
    background:#eee;
    cursor:pointer;
    font-weight:600;
  }
  .chip.active{
    background:#ff6a00;
    color:#fff;
  }
  .list{
    display:grid;
    gap:10px;
  }
  .card{
    border:1px solid #eee;
    border-radius:12px;
    overflow:hidden;
    background:#fff;
  }
  .card img{
    width:100%;
    height:140px;
    object-fit:cover;
    background:#ececec;
  }
  .meta{padding:10px}
  .meta h4{margin:0 0 6px 0;font-size:15px}
  .muted{color:#666;font-size:12px}
  .fee{
    display:none;
  }
  .input{
    width:100%;
    padding:10px;
    border:1px solid #ddd;
    border-radius:8px;
    box-sizing:border-box;
  }
  .hide{display:none}
  .service-tabs{
    position:fixed;
    left:0;right:0;bottom:58px;
    background:#fff;
    border-top:1px solid #eee;
    border-bottom:1px solid #eee;
    padding:8px 10px;
    z-index:98;
    display:flex;
    gap:8px;
    overflow-x:auto;
  }
  .ride-form .input{margin-top:6px}
  .ride-form .btn{margin-top:8px}
  #rideMap{width:100%;height:520px;border-radius:12px;border:1px solid #e5e5e5;margin-top:8px}
  .bottom-nav{
    position:fixed;
    left:0;right:0;bottom:0;
    background:#fff;
    border-top:1px solid #ddd;
    display:flex;
    justify-content:space-around;
    z-index:99;
  }
  .nav-item{
    flex:1;
    text-align:center;
    padding:8px 4px;
    font-size:11px;
    color:#444;
  }
  .nav-item img{display:block;margin:0 auto 4px auto}
  .nav-item.active{color:#ff6a00;font-weight:700}
</style>
</head>
<body>
  <div class="top">
    <span>Food / Auto Nearby</span>
    <div class="row">
      <button class="btn orange" id="openListingTopBtn">+ Add Listing</button>
      <button class="btn" onclick="location.href='F-account.html'">F-Account</button>
      <button class="btn" onclick="location.href='index.html'">Home</button>
    </div>
  </div>

  <div class="section">
    <div class="row" style="justify-content:space-between">
      <strong>Current Location</strong>
      <button class="btn orange" id="locBtn">Refresh GPS</button>
    </div>
    <div id="locText" class="muted" style="margin-top:8px">Detecting your current location...</div>
  </div>

  <div class="section">
    <div class="row" style="justify-content:space-between"><strong>Nearby Partners</strong></div>
    <div id="resultsInfo" class="muted" style="margin-top:8px"></div>
    <div class="list" id="listingBox" style="margin-top:10px"></div>
  </div>

  <div class="section hide" id="listingFormWrap">
    <strong>Create Listing</strong>
    <div class="muted" style="margin:6px 0 10px 0">Upload your own photo, or use quick auto-enhance preview.</div>
    <div class="row">
      <input id="storeName" class="input" placeholder="Store / Driver name">
    </div>
    <div class="row" style="margin-top:8px">
      <select id="storeType" class="input">
        <option value="food">Food</option>
        <option value="grocery">Grocery</option>
        <option value="ride">Ride / Auto</option>
        <option value="agent">Agent (Plumber/Electrician)</option>
      </select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="storePhone" class="input" placeholder="Phone number">
    </div>
    <div class="row" style="margin-top:8px">
      <input id="storeImage" type="file" accept="image/*" class="input">
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="enhanceBtn">Auto Enhance Photo</button>
      <button class="btn orange" id="saveListingBtn">Pay INR 500 & Submit</button>
    </div>
    <div id="enhanceText" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="section hide ride-form" id="rideFormSection">
    <strong>Book Ride</strong>
    <div class="muted" style="margin-top:6px">Pickup is auto-set from your current GPS location.</div>
    <input id="dropTextInput" class="input" placeholder="Drop location text (e.g. Hinjewadi Phase 1)">
    <button class="btn" id="dropGeoBtn" type="button">Find Drop On Map</button>
    <div id="rideMap"></div>
    <input id="dropLatInput" type="hidden">
    <input id="dropLngInput" type="hidden">
    <button class="btn orange" id="rideRequestBtn" type="button">Request Ride Now</button>
    <div id="rideTrackText" class="muted" style="margin-top:8px"></div>
    <div class="row">
      <input id="rideTrackIdInput" class="input" placeholder="Ride request id for tracking">
      <button class="btn" id="rideTrackBtn" type="button">Track</button>
    </div>
    <div class="row">
      <input id="rideOtpInput" class="input" placeholder="Enter start OTP">
      <button class="btn" id="rideOtpBtn" type="button">Verify OTP</button>
    </div>
  </div>

  <div class="service-tabs" id="serviceTabs">
    <button class="chip active" data-type="food">Food</button>
    <button class="chip" data-type="grocery">Grocery</button>
    <button class="chip" data-type="ride">Ride / Auto</button>
    <button class="chip" data-type="agent">Agent</button>
  </div>

  <div class="bottom-nav">
    <div class="nav-item" onclick="location.href='index.html'">
      <img src="https://img.icons8.com/ios-filled/24/000000/home.png" alt="">
      <span>Home</span>
    </div>
    <div class="nav-item active">
      <img src="https://img.icons8.com/ios-filled/24/ff6a00/marker.png" alt="">
      <span>Food/Auto</span>
    </div>
    <div class="nav-item" onclick="location.href='account.html'">
      <img src="https://img.icons8.com/ios-filled/24/000000/user.png" alt="">
      <span>Account</span>
    </div>
  </div>

<script>
const supa = window.supa || window.novaCreateSupabaseClient();
const listingBox = document.getElementById("listingBox");
const locText = document.getElementById("locText");
const resultsInfo = document.getElementById("resultsInfo");
const listingFormWrap = document.getElementById("listingFormWrap");
const chips = Array.from(document.querySelectorAll("#serviceTabs .chip"));
let activeType = "food";
let myLat = null;
let myLng = null;
const radiusKm = 30;
let user = null;
let rideMap = null;
let ridePickupMarker = null;
let rideDropMarker = null;
let rideTrackTimer = null;
let geoWatchId = null;
let ridePickupCircle = null;

function moneyInr(value){
  return "INR " + Number(value || 0).toFixed(2);
}

function haversineKm(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

function renderRows(rows){
  listingBox.innerHTML = "";
  if(!rows.length){
    listingBox.innerHTML = '<div class="muted">No partners found in selected radius.</div>';
    return;
  }
  rows.forEach(row => {
    const distance = (myLat != null && myLng != null && Number.isFinite(Number(row.lat)) && Number.isFinite(Number(row.lng)))
      ? haversineKm(myLat, myLng, Number(row.lat), Number(row.lng))
      : null;
    const actionLabel = row.listing_type === "ride"
      ? "Request Ride"
      : (row.listing_type === "agent" ? "Book Agent" : "Order Now");
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <img src="${row.image_url || "Images/no-image.jpg"}" alt="">
      <div class="meta">
        <h4>${row.store_name || "Listing"}</h4>
        <div class="muted">Type: ${(row.listing_type || "").toUpperCase()} | ${row.open_now ? "Open now" : "Closed"}</div>
        <div class="muted">Phone: ${row.phone || "-"}</div>
        <div class="muted">${distance == null ? "Distance unknown" : ("Distance: " + distance.toFixed(1) + " km")}</div>
        <div class="row" style="margin-top:8px">
          <button
            class="btn orange action-btn"
            data-id="${String(row.id || "")}"
            data-type="${String(row.listing_type || "")}"
            data-name="${String(row.store_name || "").replace(/"/g, "&quot;")}"
          >${actionLabel}</button>
        </div>
      </div>
    `;
    listingBox.appendChild(div);
  });
}

async function loadListings(){
  if(myLat == null || myLng == null){
    resultsInfo.textContent = "Getting your live location...";
    listingBox.innerHTML = '<div class="muted">Please allow location access to see nearby services.</div>';
    return;
  }
  let rows = [];
  const bases = buildApiBases();
  const endpoint = activeType === "agent" ? "/api/local/agents/nearby" : "/api/local/nearby";
  for(const base of bases){
    try{
      const url = activeType === "agent"
        ? `${base}${endpoint}?service_category=&lat=${encodeURIComponent(String(myLat))}&lng=${encodeURIComponent(String(myLng))}&radius_km=${encodeURIComponent(String(radiusKm))}`
        : `${base}${endpoint}?type=${encodeURIComponent(activeType)}&lat=${encodeURIComponent(String(myLat))}&lng=${encodeURIComponent(String(myLng))}&radius_km=${encodeURIComponent(String(radiusKm))}&limit=80`;
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) continue;
      const payload = await res.json().catch(() => null);
      if(payload?.ok && Array.isArray(payload.listings || payload.agents)){
        rows = (payload.listings || payload.agents || []).map((item) => {
          if(activeType !== "agent") return item;
          return {
            id: item.id,
            store_name: item.title || "Agent",
            listing_type: "agent",
            phone: item.phone || "",
            image_url: item.image_url || "Images/no-image.jpg",
            lat: item.lat,
            lng: item.lng,
            open_now: !!item.available_now
          };
        });
        break;
      }
    }catch(_){ }
  }
  if(myLat != null && myLng != null){
    rows = rows.filter(row => {
      if(!Number.isFinite(Number(row.lat)) || !Number.isFinite(Number(row.lng))) return false;
      const d = haversineKm(myLat, myLng, Number(row.lat), Number(row.lng));
      return d <= radiusKm;
    });
  }
  resultsInfo.textContent = `${rows.length} result(s) in ${radiusKm} km radius`;
  const rideForm = document.getElementById("rideFormSection");
  if(rideForm) rideForm.classList.toggle("hide", activeType !== "ride");
  renderRows(rows);
}

async function setDropPoint(lat, lng, resolveName){
  document.getElementById("dropLatInput").value = lat.toFixed(6);
  document.getElementById("dropLngInput").value = lng.toFixed(6);
  if(rideMap && window.L){
    if(rideDropMarker){
      rideDropMarker.setLatLng([lat, lng]);
    }else{
      rideDropMarker = window.L.marker([lat, lng], { draggable:true }).addTo(rideMap);
      rideDropMarker.on("dragend", async () => {
        const p = rideDropMarker.getLatLng();
        const dlat = Number(p?.lat);
        const dlng = Number(p?.lng);
        if(!Number.isFinite(dlat) || !Number.isFinite(dlng)) return;
        await setDropPoint(dlat, dlng, true);
      });
    }
    rideMap.panTo([lat, lng], { animate:true });
  }
  if(resolveName){
    const place = await resolvePlaceName(lat, lng);
    if(place){
      document.getElementById("dropTextInput").value = place;
    }
  }
}

async function initRideMap(){
  if(rideMap) return;
  if(typeof window.L === "undefined"){
    const mapWrap = document.getElementById("rideMap");
    if(mapWrap){
      mapWrap.innerHTML = '<div class="muted" style="padding:14px">Map unavailable on this device right now.</div>';
    }
    return;
  }
  const center = [myLat ?? 18.5204, myLng ?? 73.8567];
  rideMap = window.L.map("rideMap", { zoomControl:true }).setView(center, 15);
  window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(rideMap);
  rideMap.on("click", async (event) => {
    const lat = Number(event?.latlng?.lat);
    const lng = Number(event?.latlng?.lng);
    if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;
    await setDropPoint(lat, lng, true);
  });
  updateRideMapMarkers();
}

function updateRideMapMarkers(){
  if(!rideMap || typeof window.L === "undefined" || myLat == null || myLng == null) return;
  const pickup = [myLat, myLng];
  if(ridePickupMarker){
    ridePickupMarker.setLatLng(pickup);
  }else{
    ridePickupMarker = window.L.marker(pickup).addTo(rideMap);
    ridePickupMarker.bindPopup("Pickup (Current Location)");
  }
  if(ridePickupCircle){
    ridePickupCircle.setLatLng(pickup);
  }else{
    ridePickupCircle = window.L.circle(pickup, {
      radius: 120,
      color: "#1d5cff",
      fillColor: "#1d5cff",
      fillOpacity: 0.12
    }).addTo(rideMap);
  }
  rideMap.setView(pickup, Math.max(rideMap.getZoom(), 15));
}

async function resolvePlaceName(lat, lng){
  try{
    const bdc = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${encodeURIComponent(String(lat))}&longitude=${encodeURIComponent(String(lng))}&localityLanguage=en`;
    const bdcRes = await fetch(bdc, { cache:"no-store" });
    if(bdcRes.ok){
      const data = await bdcRes.json().catch(() => null);
      const parts = [
        data?.locality || data?.city || data?.principalSubdivision || "",
        data?.principalSubdivision || "",
        data?.countryName || ""
      ].filter(Boolean);
      if(parts.length) return parts.join(", ").slice(0, 140);
    }
  }catch(_){ }
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(String(lat))}&lon=${encodeURIComponent(String(lng))}`;
    const res = await fetch(url, { headers:{ "Accept":"application/json" }, cache:"no-store" });
    if(res.ok){
      const json = await res.json().catch(() => null);
      const addr = json?.address || {};
      const name = [
        addr.road || addr.suburb || addr.neighbourhood || addr.village || addr.town || addr.city || "",
        addr.state || "",
        addr.country || ""
      ].filter(Boolean).join(", ").slice(0, 140);
      if(name) return name;
    }
  }catch(_){ }
  return "";
}

async function detectLocation(){
  if(!navigator.geolocation){
    locText.textContent = "GPS not supported on this device.";
    return;
  }
  locText.textContent = "Detecting location...";
  navigator.geolocation.getCurrentPosition(async (pos) => {
    myLat = Number(pos.coords.latitude);
    myLng = Number(pos.coords.longitude);
    const acc = Number(pos.coords.accuracy || 0);
    locText.textContent = `Live location detected. Accuracy ~${Math.round(acc)}m`;
    const dropLatInput = document.getElementById("dropLatInput");
    const dropLngInput = document.getElementById("dropLngInput");
    if(dropLatInput && !String(dropLatInput.value || "").trim()){
      dropLatInput.value = myLat.toFixed(6);
    }
    if(dropLngInput && !String(dropLngInput.value || "").trim()){
      dropLngInput.value = myLng.toFixed(6);
    }
    await initRideMap();
    updateRideMapMarkers();
    resolvePlaceName(myLat, myLng).then((place) => {
      if(place){
        locText.textContent = `Live current location: ${place}${acc ? ` (~${Math.round(acc)}m)` : ""}`;
      }
    }).catch(()=>{});
    loadListings();
  }, () => {
    locText.textContent = "Location permission denied. Enable location in browser/app settings.";
    initRideMap();
    resultsInfo.textContent = "Location permission is required for nearby services.";
    listingBox.innerHTML = '<div class="muted">Location blocked. Turn on location permission and refresh GPS.</div>';
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
}

function startLiveLocationWatch(){
  if(!navigator.geolocation) return;
  if(geoWatchId != null){
    try{ navigator.geolocation.clearWatch(geoWatchId); }catch(_){ }
    geoWatchId = null;
  }
  geoWatchId = navigator.geolocation.watchPosition(async (pos) => {
    const lat = Number(pos.coords.latitude);
    const lng = Number(pos.coords.longitude);
    if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;
    const changed = (myLat == null || myLng == null)
      ? true
      : (Math.abs(myLat - lat) > 0.0003 || Math.abs(myLng - lng) > 0.0003);
    myLat = lat;
    myLng = lng;
    await initRideMap();
    updateRideMapMarkers();
    const acc = Number(pos.coords.accuracy || 0);
    if(changed){
      resolvePlaceName(myLat, myLng).then((place) => {
        if(place){
          locText.textContent = `Live current location: ${place}${acc ? ` (~${Math.round(acc)}m)` : ""}`;
        }
      }).catch(()=>{});
      loadListings();
    }
  }, () => {}, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
}

async function ensureUser(){
  if(!supa?.auth) return null;
  const { data } = await supa.auth.getSession();
  user = data?.session?.user || null;
  return user;
}

async function uploadListingImage(file, uid){
  if(!file || !supa) return "";
  const ext = (file.name || "jpg").split(".").pop().toLowerCase();
  const path = `local-listings/${uid || "guest"}-${Date.now()}.${ext}`;
  const { error } = await supa.storage.from("chat_media").upload(path, file, { upsert:true });
  if(error) return "";
  const { data } = supa.storage.from("chat_media").getPublicUrl(path);
  return data?.publicUrl || "";
}

async function createListing(){
  const me = await ensureUser();
  if(!me){
    alert("Please login first.");
    location.href = "login.html";
    return;
  }
  if(myLat == null || myLng == null){
    alert("Please enable GPS first.");
    return;
  }
  const storeName = document.getElementById("storeName").value.trim();
  const storeType = document.getElementById("storeType").value;
  const phone = document.getElementById("storePhone").value.trim();
  const imgFile = document.getElementById("storeImage").files[0] || null;
  if(!storeName || !phone){
    alert("Store name and phone required.");
    return;
  }
  let imageUrl = "Images/no-image.jpg";
  if(imgFile){
    const uploaded = await uploadListingImage(imgFile, me.id);
    if(uploaded) imageUrl = uploaded;
  }
  const payload = {
    user_id: me.id,
    store_name: storeName,
    listing_type: storeType,
    phone,
    image_url: imageUrl,
    lat: myLat,
    lng: myLng
  };
  const bases = buildApiBases();
  let ok = false;
  for(const base of bases){
    try{
      const endpoint = storeType === "agent" ? "/api/local/agents/create" : "/api/local/listings/create";
      const body = storeType === "agent"
        ? {
          user_id: me.id,
          service_category: "general",
          title: storeName,
          phone,
          price_per_visit_inr: 199,
          lat: myLat,
          lng: myLng,
          image_url: imageUrl
        }
        : payload;
      const res = await fetch(`${base}${endpoint}`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok) continue;
      const json = await res.json().catch(() => null);
      if(json?.ok){
        ok = true;
        break;
      }
    }catch(_){ }
  }
  if(!ok){
    alert("Listing save failed. Ensure backend + local_listings tables are ready.");
    return;
  }
  alert(storeType === "agent"
    ? "Agent profile submitted."
    : "Listing submitted. INR 500 listing fee marked. Awaiting approval.");
  listingFormWrap.classList.add("hide");
}

async function createOrderForListing(listingId, listingName, type){
  const me = await ensureUser();
  if(!me){
    alert("Please login first.");
    location.href = "login.html";
    return;
  }
  const address = prompt("Enter delivery address");
  if(!address) return;
  const amount = Number(prompt("Enter total amount in INR", "120") || 0);
  if(!amount || amount <= 0) return;
  for(const base of buildApiBases()){
    try{
      const res = await fetch(`${base}/api/local/orders/create`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          user_id: me.id,
          listing_id: listingId,
          service_type: type,
          amount_inr: amount,
          delivery_address: address,
          note: `Order from ${listingName || "listing"}`
        })
      });
      const json = await res.json().catch(()=>null);
      if(res.ok && json?.ok){
        alert("Order placed successfully.");
        return;
      }
    }catch(_){ }
  }
  alert("Order failed.");
}

async function createRideRequest(){
  const me = await ensureUser();
  if(!me){
    alert("Please login first.");
    location.href = "login.html";
    return;
  }
  if(myLat == null || myLng == null){
    alert("Enable GPS first.");
    return;
  }
  const dropText = String(document.getElementById("dropTextInput")?.value || "").trim();
  if(!dropText){
    alert("Enter drop location text.");
    return;
  }
  const dropLat = Number(document.getElementById("dropLatInput")?.value || 0);
  const dropLng = Number(document.getElementById("dropLngInput")?.value || 0);
  if(!Number.isFinite(dropLat) || !Number.isFinite(dropLng) || Math.abs(dropLat) > 90 || Math.abs(dropLng) > 180){
    alert("Please select drop location from map.");
    return;
  }
  for(const base of buildApiBases()){
    try{
      const res = await fetch(`${base}/api/local/rides/request`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          user_id: me.id,
          pickup_lat: myLat,
          pickup_lng: myLng,
          drop_lat: dropLat,
          drop_lng: dropLng,
          pickup_text: "Current location",
          drop_text: dropText
        })
      });
      const json = await res.json().catch(()=>null);
      if(res.ok && json?.ok){
        const reqId = String(json?.ride_request?.id || "");
        const rideTrackIdInput = document.getElementById("rideTrackIdInput");
        if(reqId && rideTrackIdInput) rideTrackIdInput.value = reqId;
        alert(`Ride request created. Offered riders: ${Number(json.offered_driver_count || 0)}`);
        startRideAutoTrack();
        return;
      }
    }catch(_){ }
  }
  alert("Ride request failed.");
}

async function trackRide(){
  const requestId = String(document.getElementById("rideTrackIdInput")?.value || "").trim();
  if(!requestId) return;
  for(const base of buildApiBases()){
    try{
      const res = await fetch(`${base}/api/local/rides/track?request_id=${encodeURIComponent(requestId)}`, { cache:"no-store" });
      const json = await res.json().catch(()=>null);
      if(res.ok && json?.ok){
        const phone = String(json?.driver_phone || "").trim();
        const otpVerified = json?.ride_request?.otp_verified ? "Yes" : "No";
        const dlat = Number(json?.driver_location?.lat);
        const dlng = Number(json?.driver_location?.lng);
        let loc = "Driver location unavailable";
        if(Number.isFinite(dlat) && Number.isFinite(dlng)){
          const place = await resolvePlaceName(dlat, dlng);
          if(place) loc = `Driver near ${place}`;
        }
        const rideTrackText = document.getElementById("rideTrackText");
        if(rideTrackText){
          rideTrackText.textContent = `Status: ${json?.ride_request?.status || "-"} | Driver phone: ${phone || "-"} | OTP verified: ${otpVerified} | ${loc}`;
        }
        return;
      }
    }catch(_){ }
  }
  const rideTrackText = document.getElementById("rideTrackText");
  if(rideTrackText) rideTrackText.textContent = "Track failed.";
}

function startRideAutoTrack(){
  if(rideTrackTimer){
    clearInterval(rideTrackTimer);
    rideTrackTimer = null;
  }
  rideTrackTimer = setInterval(() => {
    trackRide().catch(()=>{});
  }, 8000);
}

async function fillDropCoordinatesFromText(){
  const dropText = String(document.getElementById("dropTextInput")?.value || "").trim();
  if(!dropText){
    alert("Enter drop text first.");
    return;
  }
  await initRideMap();
  try{
    const photonUrl = `https://photon.komoot.io/api/?q=${encodeURIComponent(dropText)}&limit=1`;
    const pRes = await fetch(photonUrl, { cache:"no-store" });
    const pJson = await pRes.json().catch(() => null);
    const coords = pJson?.features?.[0]?.geometry?.coordinates;
    const lng = Number(Array.isArray(coords) ? coords[0] : NaN);
    const lat = Number(Array.isArray(coords) ? coords[1] : NaN);
    if(Number.isFinite(lat) && Number.isFinite(lng)){
      await setDropPoint(lat, lng, true);
      return;
    }
  }catch(_){ }
  try{
    const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(dropText)}&limit=1`;
    const nRes = await fetch(nominatimUrl, { cache:"no-store" });
    const nJson = await nRes.json().catch(() => []);
    const first = Array.isArray(nJson) ? nJson[0] : null;
    const lat = Number(first?.lat);
    const lng = Number(first?.lon);
    if(Number.isFinite(lat) && Number.isFinite(lng)){
      await setDropPoint(lat, lng, true);
      return;
    }
  }catch(_){ }
  alert("Location name not found. Try area + city (example: Hinjewadi Pune).");
}

async function verifyRideOtp(){
  const me = await ensureUser();
  if(!me){
    location.href = "login.html";
    return;
  }
  const requestId = String(document.getElementById("rideTrackIdInput")?.value || "").trim();
  const otp = String(document.getElementById("rideOtpInput")?.value || "").trim();
  if(!requestId || !otp){
    alert("Enter ride request id and OTP.");
    return;
  }
  for(const base of buildApiBases()){
    try{
      const res = await fetch(`${base}/api/local/rides/otp/verify`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          request_id: requestId,
          rider_user_id: me.id,
          otp
        })
      });
      const json = await res.json().catch(()=>null);
      if(res.ok && json?.ok){
        alert("OTP verified. Ride started.");
        trackRide();
        return;
      }
    }catch(_){ }
  }
  alert("OTP verification failed.");
}

async function createAgentBooking(agentId){
  const me = await ensureUser();
  if(!me){
    alert("Please login first.");
    location.href = "login.html";
    return;
  }
  const address = prompt("Enter service address");
  if(!address) return;
  for(const base of buildApiBases()){
    try{
      const res = await fetch(`${base}/api/local/agents/book`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          customer_user_id: me.id,
          agent_id: agentId,
          service_address: address,
          note: "Booked from Food/Auto section"
        })
      });
      const json = await res.json().catch(()=>null);
      if(res.ok && json?.ok){
        alert("Agent booking created.");
        return;
      }
    }catch(_){ }
  }
  alert("Agent booking failed.");
}

function buildApiBases(){
  const out = [];
  const push = (raw) => {
    const clean = String(raw || "").trim().replace(/\/+$/g, "");
    if(!clean) return;
    if(!/^https?:\/\//i.test(clean)) return;
    if(!out.includes(clean)) out.push(clean);
  };
  push(window.CONTEST_API_BASE || window.API_BASE || "");
  try{
    push(localStorage.getItem("contest_api_base"));
    push(localStorage.getItem("api_base"));
  }catch(_){ }
  if(/^https?:\/\//i.test(location.origin || "")) push(location.origin);
  push("https://novagapp-mart.onrender.com");
  return out;
}

document.getElementById("locBtn").addEventListener("click", detectLocation);
chips.forEach(chip => {
  chip.addEventListener("click", () => {
    chips.forEach(c => c.classList.remove("active"));
    chip.classList.add("active");
    activeType = chip.dataset.type || "food";
    loadListings();
  });
});
listingBox.addEventListener("click", (e) => {
  const btn = e.target.closest(".action-btn");
  if(!btn) return;
  const id = String(btn.dataset.id || "");
  const type = String(btn.dataset.type || "");
  const name = String(btn.dataset.name || "");
  if(type === "ride"){
    createRideRequest();
    return;
  }
  if(type === "agent"){
    createAgentBooking(id);
    return;
  }
  createOrderForListing(id, name, type);
});
document.getElementById("openListingTopBtn").addEventListener("click", () => {
  listingFormWrap.classList.toggle("hide");
});
document.getElementById("enhanceBtn").addEventListener("click", () => {
  document.getElementById("enhanceText").textContent = "Auto-enhance preview ready. (Advanced AI pipeline can be connected next.)";
});
document.getElementById("saveListingBtn").addEventListener("click", createListing);
document.getElementById("rideRequestBtn").addEventListener("click", createRideRequest);
document.getElementById("rideTrackBtn").addEventListener("click", trackRide);
document.getElementById("rideOtpBtn").addEventListener("click", verifyRideOtp);
document.getElementById("dropGeoBtn").addEventListener("click", fillDropCoordinatesFromText);

detectLocation();
initRideMap();
startLiveLocationWatch();
loadListings();
</script>
</body>
</html>
