<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Local Rider</title><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script src="global.js"></script><script src="public-config.js"></script><style>body{font-family:Arial;background:#f5f5f5;margin:0}.top{background:#111;color:#fff;padding:12px;font-weight:700}.box{background:#fff;margin:10px;border-radius:12px;padding:12px}.row{border:1px solid #eee;border-radius:10px;padding:10px;margin:8px 0}.btn{border:none;border-radius:8px;padding:8px 10px;background:#ff6a00;color:#fff;cursor:pointer;margin-right:8px}</style></head><body><div class="top">Rider Dispatch Panel</div><div class="box"><button class="btn" onclick="goOnline()">Go Online</button><button class="btn" onclick="loadRides()">Refresh Rides</button><div id="msg"></div><div id="list"></div></div><script>
const supa=window.supa||window.novaCreateSupabaseClient();let me=null;function bases(){const o=[];const p=v=>{v=String(v||'').trim().replace(/\/+$/g,'');if(v&&/^https?:\/\//i.test(v)&&!o.includes(v))o.push(v)};p(window.CONTEST_API_BASE||window.API_BASE||'');try{p(localStorage.getItem('contest_api_base'));p(localStorage.getItem('api_base'))}catch(_){};if(/^https?:\/\//i.test(location.origin||''))p(location.origin);p('https://novagapp-mart.onrender.com');return o}
async function meUser(){if(me)return me;const {data}=await supa.auth.getSession();me=data?.session?.user||null;if(!me){location.href='login.html';return null;}return me;}
async function goOnline(){const u=await meUser();if(!u)return;navigator.geolocation.getCurrentPosition(async p=>{for(const b of bases()){try{const r=await fetch(b+'/api/local/riders/location',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:u.id,lat:p.coords.latitude,lng:p.coords.longitude,is_online:true})});const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){document.getElementById('msg').textContent='Online location updated';return}}catch(_){}}document.getElementById('msg').textContent='Online update failed';},()=>{document.getElementById('msg').textContent='Location permission denied';});}
async function loadRides(){const u=await meUser();if(!u)return;for(const b of bases()){try{const r=await fetch(`${b}/api/local/rides/for-rider?user_id=${encodeURIComponent(u.id)}`);const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){render(j.rides||[]);return}}catch(_){}}}
function render(rows){const box=document.getElementById('list');box.innerHTML=''; if(!rows.length){box.textContent='No ride requests';return;} rows.forEach(r=>{const d=document.createElement('div');d.className='row';const canAccept=(r.status==='searching');d.innerHTML=`<b>${r.pickup_text||'Pickup'}</b> -> ${r.drop_text||'Drop'}<div>Status: ${r.status||''}</div>${canAccept?`<button class='btn' onclick="acceptRide('${r.id}')">Accept</button>`:''}<button class='btn' onclick="setRideStatus('${r.id}','arriving')">Arriving</button><button class='btn' onclick="setRideStatus('${r.id}','on_trip')">On Trip</button><button class='btn' onclick="setRideStatus('${r.id}','completed')">Complete</button>`;box.appendChild(d)})}
async function acceptRide(id){const u=await meUser();if(!u)return;for(const b of bases()){try{const r=await fetch(b+'/api/local/rides/accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({request_id:id,driver_user_id:u.id})});const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){loadRides();return}}catch(_){}}alert('accept failed')}
async function setRideStatus(id,status){const u=await meUser();if(!u)return;for(const b of bases()){try{const r=await fetch(b+'/api/local/rides/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({request_id:id,user_id:u.id,status})});const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){loadRides();return}}catch(_){}}alert('status failed')}
meUser().then(loadRides);
</script></body></html>
