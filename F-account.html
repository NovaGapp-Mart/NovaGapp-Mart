<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>F-Account</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="global.js"></script>
<script src="public-config.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap">
<style>
:root{
  --brand:#ff6a00;
  --brand-dark:#d45100;
  --ink:#15181f;
  --mut:#64748b;
  --line:#e4d8cf;
  --bg:#fff7f1;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Manrope",sans-serif;
  background:radial-gradient(1000px 520px at 18% -120px,#ffe4cc 0,#fff3e9 56%,#fff8f3 100%);
  color:var(--ink);
  padding-bottom:32px;
}
.top{
  position:sticky;
  top:0;
  z-index:30;
  background:rgba(20,20,24,.95);
  border-bottom:1px solid rgba(255,255,255,.08);
  backdrop-filter:blur(8px);
  color:#fff;
  padding:12px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.top b{font-size:18px;letter-spacing:.01em}
.w{padding:14px;max-width:1180px;margin:0 auto}
.hero{
  background:linear-gradient(135deg,#1b1f2a 0,#2a1f18 50%,#46210a 100%);
  color:#fff;
  border:1px solid #53311d;
  border-radius:18px;
  padding:16px;
  box-shadow:0 18px 32px rgba(30,22,16,.25);
  margin-bottom:12px;
}
.hero .mut{color:#ffd9bf}
.flow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.flow span{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.14);font-size:12px;font-weight:700}
.layout{display:grid;grid-template-columns:minmax(0,1.55fr) minmax(320px,1fr);gap:12px;align-items:start}
.c{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;margin-bottom:10px;box-shadow:0 10px 22px rgba(136,74,28,.12)}
.title{display:flex;justify-content:space-between;align-items:center;gap:8px}
.title b{font-size:17px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.r3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px}
.in,select,textarea{width:100%;padding:11px 12px;border:1px solid #e2d4c9;border-radius:11px;background:#fff;color:#111827;font-family:"Manrope",sans-serif;font-size:14px}
.in:focus,select:focus,textarea:focus{outline:none;border-color:#ff8f45;box-shadow:0 0 0 3px rgba(255,106,0,.17)}
.b{border:none;border-radius:11px;padding:10px 12px;background:linear-gradient(135deg,#ff7a1a 0,#ff5900 100%);color:#fff;font-weight:800;cursor:pointer;letter-spacing:.01em}
.bd{background:#1f2937}.bg{background:#334155}.bo{background:#0f9f50}
.mut{font-size:12px;color:var(--mut);font-weight:500}
.roles{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.role{border:1px solid #ead9cc;border-radius:13px;padding:12px;background:#fff;cursor:pointer;text-align:left;transition:all .18s ease}
.role b{display:block;margin-bottom:3px}
.role:hover{transform:translateY(-1px);box-shadow:0 12px 20px rgba(163,100,45,.12)}
.role.a{border-color:#ff6a00;background:linear-gradient(180deg,#fff5ec 0,#fff 100%);box-shadow:0 12px 22px rgba(255,106,0,.16)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:#fff0e5;color:#a54200;font-size:11px;font-weight:800}
.hide{display:none!important}
#m{height:240px;border:1px solid #eddace;border-radius:12px;margin-top:8px;overflow:hidden}
.p{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.pill{padding:6px 10px;border-radius:999px;background:#fff0e5;color:#a54200;font-size:12px;font-weight:700}
.actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.wallet{padding:10px 11px;border-radius:12px;background:#fff7f1;border:1px solid #f0ddcf}
.policy-grid{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
.policy{border:1px solid #f0ddcf;border-radius:12px;padding:10px;background:#fffaf6}
.policy b{display:block;font-size:14px;color:#15181f}
.policy span{display:block;margin-top:3px;color:#475569;font-size:12px;font-weight:600}
.notice{margin-top:8px;border:1px dashed #ffbd93;border-radius:10px;background:#fff6ef;padding:10px;font-size:12px;color:#8b3a05;font-weight:700}
@media(max-width:1020px){.layout{grid-template-columns:1fr}}
@media(max-width:900px){.roles,.row,.r3,.actions{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="top">
  <b>F-Account Setup</b>
  <div>
    <button class="b bd" onclick="location.href='index.html'">Home</button>
    <button class="b" onclick="location.href='food-auto.html'">Services</button>
  </div>
</div>

<div class="w">
  <div class="hero">
    <b>Enterprise onboarding for local services</b>
    <div class="mut" style="margin-top:6px">Provider roles (Seller, Driver, Agent) need INR 500 one-time listing fee + 10% monthly platform share. Customer role is free.</div>
    <div class="flow">
      <span>1. Choose role</span>
      <span>2. Verify identity</span>
      <span>3. Save role profile</span>
      <span>4. Activate account</span>
    </div>
  </div>

  <div class="layout">
    <div>
      <div class="c">
        <div class="title"><b>1) Choose Account Type</b><span class="chip">Required</span></div>
        <div class="roles">
          <button id="rr" class="role" onclick="sel('rider')"><b>Become Driver</b><div class="mut">Ride partner with live trip requests</div></button>
          <button id="rs" class="role" onclick="sel('seller')"><b>Become Seller</b><div class="mut">Food/Grocery store with unlimited product listing</div></button>
          <button id="ra" class="role" onclick="sel('agent')"><b>Become Agent</b><div class="mut">Home service expert profile</div></button>
          <button id="rc" class="role" onclick="sel('consumer')"><b>I am Customer</b><div class="mut">Free account to book rides/orders/services</div></button>
        </div>
        <div class="mut" style="margin-top:8px">Selected: <b id="sr">None</b></div>
      </div>

      <div class="c">
        <div class="title"><b>2) Identity Verification</b><span class="chip" id="verifyChip">Providers: OTP + GPS</span></div>
        <div id="u" class="mut" style="margin-top:6px">Checking login...</div>
        <div class="row">
          <input id="nm" class="in" placeholder="Full name">
          <input id="ph" class="in" placeholder="Phone (+91...)">
        </div>
        <div id="otpWrap">
          <div class="row">
            <button id="send" class="b bg">Send OTP</button>
            <div style="display:flex;gap:6px">
              <input id="otp" class="in" placeholder="6-digit OTP">
              <button id="ver" class="b bo">Verify</button>
            </div>
          </div>
          <div id="os" class="mut" style="margin-top:6px">OTP not sent</div>
        </div>
        <div id="gpsWrap">
          <div class="row">
            <input id="ad" class="in" placeholder="Auto-detected address">
            <button id="gps" class="b">Use Live GPS</button>
          </div>
          <div id="gs" class="mut" style="margin-top:6px">GPS not locked</div>
          <div id="m"></div>
        </div>
        <div id="consumerNotice" class="notice hide">Customer account free hai: OTP, GPS lock aur listing fee required nahi hai.</div>
      </div>

      <div class="c">
        <div class="title"><b>3) Role Details</b><span class="chip">Role specific</span></div>
        <div id="fr" class="hide">
          <div class="row"><select id="vtype"><option value="bike">Bike</option><option value="auto" selected>Auto</option><option value="car">Car</option></select><input id="vno" class="in" placeholder="Vehicle number"></div>
          <div class="r3"><input id="bf" class="in" type="number" placeholder="Base fare"><input id="pk" class="in" type="number" placeholder="Per km"><input id="pm" class="in" type="number" placeholder="Per min"></div>
          <div class="row"><input id="rrad" class="in" type="number" placeholder="Service radius km"><input id="docs" class="in" placeholder="Docs URL"></div>
        </div>

        <div id="fs" class="hide">
          <div class="row"><select id="stype"><option value="food">Food</option><option value="grocery">Grocery</option></select><input id="sn" class="in" placeholder="Store name"></div>
          <div class="r3"><input id="dc" class="in" type="number" placeholder="Delivery charge"><input id="mo" class="in" type="number" placeholder="Min order"><input id="ot" class="in" placeholder="Open time"></div>
          <div class="row"><input id="ct" class="in" placeholder="Close time"><input id="si" class="in" placeholder="Image URL"></div>
          <div class="notice">Seller account me unlimited products add kar sakte ho. Shop ki live location food/grocery listing me show hogi.</div>
        </div>

        <div id="fa" class="hide">
          <div class="row"><select id="ac"><option value="electrician">Electrician</option><option value="plumber">Plumber</option><option value="ac_repair">AC Repair</option><option value="carpenter">Carpenter</option><option value="mechanic">Mechanic</option><option value="painter">Painter</option><option value="cleaning">Cleaning</option></select><input id="at" class="in" placeholder="Profile title"></div>
          <div class="r3"><input id="ae" class="in" type="number" placeholder="Experience"><input id="av" class="in" type="number" placeholder="Visit charge"><input id="ah" class="in" type="number" placeholder="Per hour"></div>
          <div class="row"><input id="ar" class="in" type="number" placeholder="Service radius km"><select id="aa"><option value="true">Available</option><option value="false">Offline</option></select></div>
        </div>
      </div>
    </div>

    <div>
      <div class="c">
        <div class="title"><b>4) Activate</b><span class="chip">Final</span></div>
        <div class="policy-grid">
          <div class="policy"><b>Provider one-time listing fee</b><span>INR 500 (Driver/Seller/Agent)</span></div>
          <div class="policy"><b>Monthly platform share</b><span>10% on completed monthly sales/revenue (provider roles)</span></div>
          <div class="policy"><b>Customer account fee</b><span>INR 0 (free role)</span></div>
        </div>
        <button id="act" class="b" style="margin-top:10px;width:100%">Activate</button>
        <div id="as" class="mut" style="margin-top:7px">Pending</div>
      </div>

      <div class="c">
        <div class="title"><b>Active Roles & Wallet</b><span class="chip">Live</span></div>
        <div id="rb" class="p"></div>
        <div class="actions">
          <button class="b bg" onclick="rw()">Refresh wallet</button>
          <div id="wt" class="wallet mut">Wallet not loaded</div>
        </div>
        <div class="actions">
          <button class="b" onclick="location.href='local-rider.html'">Driver dashboard</button>
          <button class="b" onclick="location.href='local-seller.html'">Seller dashboard</button>
        </div>
        <div class="actions">
          <button class="b" onclick="location.href='local-agent.html'">Agent dashboard</button>
          <button class="b bd" onclick="location.href='food-auto.html'">Service app</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const supa = window.supa || window.novaCreateSupabaseClient();
const s = { me:null, role:"", otpTok:"", otpOk:false, lat:null, lng:null, wType:"" };
let map = null;
let mk = null;

const ROLE_META = {
  rider: { label:"Driver", wallet:"driver", otp:true, gps:true, payment:true },
  seller:{ label:"Food Seller", wallet:"seller", otp:true, gps:true, payment:true },
  agent: { label:"Service Agent", wallet:"agent", otp:true, gps:true, payment:true },
  consumer:{ label:"Customer", wallet:"customer", otp:false, gps:false, payment:false }
};

const q = (id) => document.getElementById(id);

function bases(){
  const out = [];
  const push = (v) => {
    const clean = String(v || "").trim().replace(/\/+$/g, "");
    if(!clean || !/^https?:\/\//i.test(clean)) return;
    if(!out.includes(clean)) out.push(clean);
  };
  push(window.CONTEST_API_BASE || window.API_BASE || "");
  try{
    push(localStorage.getItem("contest_api_base"));
    push(localStorage.getItem("api_base"));
  }catch(_){ }
  if(/^https?:\/\//i.test(location.origin || "")) push(location.origin);
  push("https://novagapp-mart.onrender.com");
  return out;
}

async function g(path){
  for(const b of bases()){
    try{
      const r = await fetch(b + path, { cache:"no-store" });
      const j = await r.json().catch(() => null);
      if(r.ok && j?.ok) return j;
    }catch(_){ }
  }
  return null;
}

async function p(path, body){
  for(const b of bases()){
    try{
      const r = await fetch(b + path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body || {})
      });
      const j = await r.json().catch(() => null);
      if(r.ok && j?.ok) return j;
      if(j?.error) return { ok:false, error:String(j.error || "api_error"), message:String(j.message || "") };
    }catch(_){ }
  }
  return { ok:false, error:"api_unreachable" };
}

function phone(v){
  v = String(v || "").trim();
  if(v.startsWith("+")) return v.replace(/[^\d+]/g, "");
  const d = v.replace(/\D/g, "");
  if(d.length === 10) return "+91" + d;
  if(d.length >= 11 && d.length <= 15) return "+" + d;
  return v;
}

function roleLabel(role){
  return ROLE_META[role]?.label || "None";
}

function walletType(role){
  return ROLE_META[role]?.wallet || "";
}

function updateRoleUi(){
  const role = s.role;
  q("sr").textContent = roleLabel(role);
  ["rr","rs","ra","rc"].forEach((id) => q(id).classList.remove("a"));
  if(role === "rider") q("rr").classList.add("a");
  if(role === "seller") q("rs").classList.add("a");
  if(role === "agent") q("ra").classList.add("a");
  if(role === "consumer") q("rc").classList.add("a");

  q("fr").classList.toggle("hide", role !== "rider");
  q("fs").classList.toggle("hide", role !== "seller");
  q("fa").classList.toggle("hide", role !== "agent");

  const provider = role === "rider" || role === "seller" || role === "agent";
  q("otpWrap").classList.toggle("hide", !provider);
  q("gpsWrap").classList.toggle("hide", !provider);
  q("consumerNotice").classList.toggle("hide", provider);
  q("verifyChip").textContent = provider ? "Providers: OTP + GPS" : "Customer: Free and instant";
  q("os").textContent = provider ? "OTP not sent" : "OTP not required for customer role";

  const btn = q("act");
  btn.textContent = role === "consumer" ? "Create Free Customer Account" : "Pay INR 500 and Activate";

  s.otpTok = "";
  s.otpOk = false;
}

function sel(role){
  s.role = String(role || "").trim();
  s.wType = walletType(s.role);
  updateRoleUi();
}

function im(){
  if(map) return;
  map = L.map("m", { zoomControl:true }).setView([18.5204,73.8567], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap contributors" }).addTo(map);
  map.on("click", (e) => {
    loc(Number(e.latlng.lat), Number(e.latlng.lng), true).catch(() => {});
  });
}

async function rev(lat, lng){
  try{
    const u = new URL("https://nominatim.openstreetmap.org/reverse");
    u.searchParams.set("format", "jsonv2");
    u.searchParams.set("addressdetails", "1");
    u.searchParams.set("zoom", "18");
    u.searchParams.set("lat", String(lat));
    u.searchParams.set("lon", String(lng));
    const r = await fetch(u.toString(), {
      cache:"no-store",
      headers:{ "Accept":"application/json", "Accept-Language":"en-IN,en;q=0.9" }
    });
    if(!r.ok) return "";
    const d = await r.json().catch(() => null);
    const a = d?.address || {};
    return ([a.road || a.neighbourhood || a.suburb || "", a.city || a.town || a.village || a.county || "", a.state || "", a.postcode || ""].filter(Boolean).join(", ") || String(d?.display_name || "")).slice(0,180);
  }catch(_){
    return "";
  }
}

async function loc(lat, lng, center){
  if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;
  s.lat = lat;
  s.lng = lng;
  if(!mk){
    mk = L.marker([lat,lng], { draggable:true }).addTo(map);
    mk.on("dragend", () => {
      const p = mk.getLatLng();
      loc(Number(p.lat), Number(p.lng), false).catch(() => {});
    });
  }else{
    mk.setLatLng([lat,lng]);
  }
  if(center && map) map.setView([lat,lng], Math.max(15, map.getZoom()));
  const a = await rev(lat, lng);
  if(a) q("ad").value = a;
}

async function gps(){
  im();
  if(!navigator.geolocation){
    q("gs").textContent = "GPS unsupported";
    return;
  }
  q("gs").textContent = "Detecting GPS...";
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const lat = Number(pos?.coords?.latitude);
    const lng = Number(pos?.coords?.longitude);
    const acc = Math.round(Number(pos?.coords?.accuracy || 0));
    if(!Number.isFinite(lat) || !Number.isFinite(lng)){
      q("gs").textContent = "GPS read failed";
      return;
    }
    await loc(lat, lng, true);
    q("gs").textContent = `GPS locked (${acc}m)`;
  }, (err) => {
    q("gs").textContent = `Permission required (${String(err?.message || "denied")})`;
  }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
}

async function me(){
  const { data } = await supa.auth.getSession();
  s.me = data?.session?.user || null;
  if(!s.me){
    location.href = "login.html";
    return null;
  }
  q("u").textContent = `${s.me.email || "Logged in"} (${s.me.id})`;
  q("nm").value = String(s.me?.user_metadata?.full_name || s.me?.user_metadata?.name || "").slice(0,80);
  if(s.me?.phone) q("ph").value = String(s.me.phone || "").slice(0,30);
  return s.me;
}

async function sendOtp(){
  const u = await me();
  if(!u) return;
  if(!s.role){
    alert("Select role first");
    return;
  }
  if(s.role === "consumer"){
    q("os").textContent = "Customer role ke liye OTP required nahi hai.";
    return;
  }
  const ph = phone(q("ph").value);
  if(!ph){
    alert("Enter valid phone");
    return;
  }
  q("ph").value = ph;
  q("os").textContent = "Sending OTP...";
  const out = await p("/api/local/provider/otp/send", { user_id:u.id, phone:ph });
  if(!out?.ok){
    q("os").textContent = `OTP failed: ${String(out?.error || "send_failed")}`;
    return;
  }
  s.otpTok = String(out.otp_token || "");
  s.otpOk = false;
  q("os").textContent = `OTP sent (${String(out.delivery || "sms")})`;
}

async function verifyOtp(){
  const u = await me();
  if(!u) return;
  if(s.role === "consumer"){
    q("os").textContent = "Customer role ke liye OTP required nahi hai.";
    return;
  }
  if(!s.otpTok){
    alert("Send OTP first");
    return;
  }
  const otp = String(q("otp").value || "").trim();
  if(!/^\d{6}$/.test(otp)){
    alert("Enter 6 digit OTP");
    return;
  }
  const out = await p("/api/local/provider/otp/verify", { user_id:u.id, otp_token:s.otpTok, otp });
  if(!out?.ok){
    s.otpOk = false;
    q("os").textContent = `OTP verify failed: ${String(out?.error || "invalid")}`;
    return;
  }
  s.otpOk = true;
  q("os").textContent = "OTP verified";
}

async function fee(role){
  const u = await me();
  if(!u) throw new Error("login_required");
  const o = await p("/api/local/role/fee/order", { user_id:u.id, role });
  if(!o?.ok || !o?.order?.razorpay_order_id) throw new Error(String(o?.error || "fee_order_failed"));
  if(typeof window.Razorpay !== "function") throw new Error("razorpay_sdk_missing");
  const nm = String(q("nm").value || "").trim();
  const ph = String(q("ph").value || "").trim();
  return await new Promise((resolve, reject) => {
    const rz = new window.Razorpay({
      key: String(o.order.key_id || ""),
      amount: Number(o.order.amount_paise || 50000),
      currency: "INR",
      name: "NovaGapp",
      description: `${roleLabel(role)} provider fee`,
      order_id: String(o.order.razorpay_order_id || ""),
      prefill: { name:nm, email:s.me?.email || "", contact:ph },
      handler: async (r) => {
        const v = await p("/api/local/role/fee/verify", {
          user_id:u.id,
          role,
          razorpay_order_id:String(r?.razorpay_order_id || ""),
          razorpay_payment_id:String(r?.razorpay_payment_id || ""),
          razorpay_signature:String(r?.razorpay_signature || "")
        });
        if(!v?.ok){
          reject(new Error(String(v?.error || "fee_verify_failed")));
          return;
        }
        resolve({ payment_ref:String(r?.razorpay_payment_id || "") });
      },
      modal:{ ondismiss:() => reject(new Error("payment_cancelled")) }
    });
    rz.open();
  });
}

async function upDriver(uid, nm, ph){
  const e = await g(`/api/local/listings/for-owner?user_id=${encodeURIComponent(uid)}&listing_type=ride`);
  const ex = Array.isArray(e?.listings) ? e.listings[0] : null;
  const body = {
    user_id:uid,
    listing_type:"ride",
    store_name:nm,
    phone:ph,
    lat:s.lat,
    lng:s.lng,
    open_now:true,
    ride_vehicle_type:String(q("vtype").value || "auto"),
    vehicle_number:String(q("vno").value || "").trim(),
    base_fare_inr:Number(q("bf").value || 0),
    per_km_rate_inr:Number(q("pk").value || 0),
    per_min_rate_inr:Number(q("pm").value || 0),
    service_radius_km:Number(q("rrad").value || 5),
    documents_url:String(q("docs").value || "").trim()
  };
  if(!body.vehicle_number) return { ok:false, error:"vehicle_number_required" };
  if(ex?.id) return p("/api/local/listings/update", Object.assign({ listing_id:String(ex.id) }, body));
  return p("/api/local/listings/create", body);
}

async function upSeller(uid, ph){
  const type = String(q("stype").value || "food");
  const name = String(q("sn").value || "").trim();
  if(!name) return { ok:false, error:"store_name_required" };
  const e = await g(`/api/local/listings/for-owner?user_id=${encodeURIComponent(uid)}&listing_type=${encodeURIComponent(type)}`);
  const ex = Array.isArray(e?.listings) ? e.listings[0] : null;
  const body = {
    user_id:uid,
    listing_type:type,
    store_name:name,
    phone:ph,
    image_url:String(q("si").value || "").trim(),
    lat:s.lat,
    lng:s.lng,
    open_now:true,
    delivery_charge_inr:Number(q("dc").value || 0),
    minimum_order_inr:Number(q("mo").value || 0),
    open_time:String(q("ot").value || "").trim(),
    close_time:String(q("ct").value || "").trim(),
    self_delivery:true
  };
  if(ex?.id) return p("/api/local/listings/update", Object.assign({ listing_id:String(ex.id) }, body));
  return p("/api/local/listings/create", body);
}

async function upAgent(uid, ph){
  const title = String(q("at").value || "").trim();
  if(!title) return { ok:false, error:"agent_title_required" };
  return p("/api/local/agents/create", {
    user_id:uid,
    service_category:String(q("ac").value || "electrician"),
    title,
    phone:ph,
    price_per_visit_inr:Number(q("av").value || 0),
    per_hour_rate_inr:Number(q("ah").value || 0),
    experience_years:Number(q("ae").value || 0),
    service_radius_km:Number(q("ar").value || 5),
    available_now:String(q("aa").value || "true") === "true",
    lat:s.lat,
    lng:s.lng
  });
}

async function activate(){
  const u = await me();
  if(!u) return;
  if(!s.role){
    alert("Select role");
    return;
  }

  const nm = String(q("nm").value || "").trim();
  const ph = phone(q("ph").value);
  if(!nm || !ph){
    alert("Name and phone required");
    return;
  }
  q("ph").value = ph;

  const meta = ROLE_META[s.role] || null;
  if(!meta){
    alert("Select valid role");
    return;
  }

  if(meta.otp && (!s.otpOk || !s.otpTok)){
    alert("OTP verify first");
    return;
  }
  if(meta.gps && (!Number.isFinite(s.lat) || !Number.isFinite(s.lng))){
    alert("Set GPS location first");
    return;
  }

  q("as").textContent = "Processing...";
  try{
    let paymentRef = "";
    if(meta.payment){
      const pay = await fee(s.role);
      paymentRef = String(pay?.payment_ref || "");
    }else{
      paymentRef = "customer_free";
    }

    const enroll = await p("/api/local/role/enroll", {
      user_id:u.id,
      role:s.role,
      display_name:nm,
      phone:ph,
      fee_paid:true,
      payment_ref:paymentRef,
      otp_token: meta.otp ? s.otpTok : ""
    });
    if(!enroll?.ok) throw new Error(String(enroll?.error || "role_enroll_failed"));

    let profileRes = { ok:true };
    if(s.role === "rider") profileRes = await upDriver(u.id, nm, ph);
    if(s.role === "seller") profileRes = await upSeller(u.id, ph);
    if(s.role === "agent") profileRes = await upAgent(u.id, ph);
    if(!profileRes?.ok) throw new Error(String(profileRes?.error || "profile_update_failed"));

    q("as").textContent = `${roleLabel(s.role)} account activated`;
    await roles();
    await rw();
    alert(`${roleLabel(s.role)} account activated`);
  }catch(err){
    q("as").textContent = `Failed: ${String(err?.message || err || "unknown")}`;
  }
}

async function roles(){
  if(!s.me) return;
  const out = await g(`/api/local/roles?user_id=${encodeURIComponent(s.me.id)}`);
  const rows = Array.isArray(out?.roles) ? out.roles : [];
  const b = q("rb");
  b.innerHTML = "";
  if(!rows.length){
    b.innerHTML = '<span class="mut">No active role</span>';
    return;
  }
  rows.forEach((r) => {
    const p = document.createElement("span");
    p.className = "pill";
    p.textContent = `${roleLabel(String(r.role || ""))} | ${String(r.status || "active")}`;
    b.appendChild(p);
  });
}

async function rw(){
  if(!s.me){
    q("wt").textContent = "Login required";
    return;
  }
  const t = s.wType || walletType(s.role);
  if(!t){
    q("wt").textContent = "Select role";
    return;
  }
  const w = await g(`/api/local/wallet?owner_user_id=${encodeURIComponent(s.me.id)}&owner_type=${encodeURIComponent(t)}`);
  const row = w?.wallet || (Array.isArray(w?.wallets) ? w.wallets[0] : null);
  const tx = await g(`/api/local/transactions?user_id=${encodeURIComponent(s.me.id)}&owner_type=${encodeURIComponent(t)}&limit=5`);
  q("wt").textContent = row
    ? `${t} wallet: INR ${Number(row.balance_inr || 0).toFixed(2)} | tx: ${Array.isArray(tx?.transactions) ? tx.transactions.length : 0}`
    : `${t} wallet not found`;
}

function bind(){
  q("send").onclick = () => sendOtp().catch(() => {});
  q("ver").onclick = () => verifyOtp().catch(() => {});
  q("gps").onclick = () => gps().catch(() => {});
  q("act").onclick = () => activate().catch(() => {});
}

(async () => {
  im();
  bind();
  await me();
  sel("consumer");
  await roles();
})();
</script>
</body>
</html>
