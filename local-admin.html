<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Local Admin</title>
<script src="global.js"></script><script src="public-config.js"></script>
<style>body{font-family:Arial;background:#f5f5f5;margin:0}.top{background:#111;color:#fff;padding:12px;font-weight:700}.box{background:#fff;margin:10px;border-radius:12px;padding:12px}.row{border:1px solid #eee;border-radius:10px;padding:10px;margin:8px 0}.btn{border:none;border-radius:8px;padding:8px 10px;background:#ff6a00;color:#fff;cursor:pointer;margin-right:8px}</style>
</head><body>
<div class="top">Local Admin Approvals</div><div class="box"><input id="token" placeholder="Admin token" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px"><button class="btn" style="margin-top:8px" onclick="loadPending()">Load Pending</button><button class="btn" style="margin-top:8px" onclick="loadSettlement()">Settlement Overview</button><button class="btn" style="margin-top:8px" onclick="markSettlementPaid()">Mark Settlement Paid</button><div id="summary" style="margin-top:8px"></div><div id="list"></div></div>
<script>
function bases(){const o=[];const p=v=>{v=String(v||'').trim().replace(/\/+$/g,'');if(v&&/^https?:\/\//i.test(v)&&!o.includes(v))o.push(v)};p(window.CONTEST_API_BASE||window.API_BASE||'');try{p(localStorage.getItem('contest_api_base'));p(localStorage.getItem('api_base'))}catch(_){};if(/^https?:\/\//i.test(location.origin||''))p(location.origin);p('https://novagapp-mart.onrender.com');return o}
async function loadPending(){const token=document.getElementById('token').value.trim();for(const b of bases()){try{const r=await fetch(b+'/api/local/admin/listings/pending',{headers:{'x-admin-token':token}});const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){render(j.listings||[],token);return}}catch(_){}}alert('failed')}
async function loadSettlement(){const token=document.getElementById('token').value.trim();for(const b of bases()){try{const r=await fetch(b+'/api/local/admin/settlement/overview',{headers:{'x-admin-token':token}});const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){document.getElementById('summary').textContent=`Month ${j.month} | Sellers: ${j.seller_count} | Gross INR ${Number(j.total_gross_inr||0).toFixed(2)} | Due INR ${Number(j.total_platform_due_inr||0).toFixed(2)}`;return}}catch(_){}}alert('overview failed')}
async function markSettlementPaid(){const token=document.getElementById('token').value.trim();const seller=prompt('Seller user id?');if(!seller)return;const month=prompt('Month (YYYY-MM)',new Date().toISOString().slice(0,7));if(!month)return;const amount=Number(prompt('Paid amount INR','0')||0);const ref=prompt('Payment ref','manual_'+Date.now())||'';for(const b of bases()){try{const r=await fetch(b+'/api/local/admin/settlement/mark-paid',{method:'POST',headers:{'Content-Type':'application/json','x-admin-token':token},body:JSON.stringify({seller_user_id:seller,month,paid_amount_inr:amount,paid_ref:ref})});const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){alert('settlement marked paid');return}}catch(_){}}alert('mark paid failed')}
function render(rows,token){const box=document.getElementById('list');box.innerHTML='';if(!rows.length){box.textContent='No pending listings';return;}rows.forEach(r=>{const d=document.createElement('div');d.className='row';d.innerHTML=`<b>${r.store_name||''}</b><div>${r.listing_type||''} | ${r.phone||''}</div><button class="btn" onclick="decision('${r.id}','approve','${token}')">Approve</button><button class="btn" onclick="decision('${r.id}','reject','${token}')">Reject</button>`;box.appendChild(d)})}
async function decision(id,action,token){for(const b of bases()){try{const r=await fetch(b+'/api/local/listings/decision',{method:'POST',headers:{'Content-Type':'application/json','x-admin-token':token},body:JSON.stringify({listing_id:id,decision:action})});const j=await r.json().catch(()=>null);if(r.ok&&j?.ok){loadPending();return}}catch(_){}}alert('action failed')}
</script></body></html>
