<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Automation Dashboard | NOVAGAPP</title>
<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#0f1420;
  color:#f7f8fb;
}
.header{
  background:linear-gradient(135deg,#ff7a00,#ff4d00);
  padding:16px;
  font-size:20px;
  font-weight:700;
}
.wrap{
  max-width:1200px;
  margin:0 auto;
  padding:16px;
}
.panel{
  background:#171e2f;
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.panel h3{
  margin:0 0 10px;
  font-size:15px;
}
.row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
input,button{
  border-radius:8px;
  border:1px solid rgba(255,255,255,.16);
  padding:10px 12px;
  font-size:13px;
}
input{
  background:#0f1420;
  color:#fff;
}
button{
  border:none;
  background:#ff7a00;
  color:#111;
  font-weight:700;
  cursor:pointer;
}
button.secondary{
  background:#2a3248;
  color:#fff;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:12px;
}
.mono{
  font-family:Consolas,monospace;
  white-space:pre-wrap;
  background:#0f1420;
  border-radius:8px;
  padding:10px;
  max-height:280px;
  overflow:auto;
  font-size:12px;
}
.muted{
  color:#a6b0c8;
  font-size:12px;
}
</style>
</head>
<body>
<div class="header">Automation Dashboard</div>
<div class="wrap">
  <div class="panel">
    <h3>Controls</h3>
    <div class="row">
      <input id="userIdInput" placeholder="User ID for report/growth" style="min-width:320px">
      <input id="monthInput" placeholder="Month (YYYY-MM)" style="width:140px">
      <button onclick="refreshAll()">Refresh</button>
      <button class="secondary" onclick="toggleAutoRefresh()" id="autoBtn">Auto: ON</button>
    </div>
    <div class="muted" id="statusText">Loading...</div>
  </div>

  <div class="panel">
    <h3>Verification Admin</h3>
    <div class="row">
      <label style="display:flex;align-items:center;gap:6px;font-size:12px">
        <input id="verificationKyc" type="checkbox" checked>
        KYC complete
      </label>
      <button onclick="submitVerificationRequest()">Create Request</button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="verificationRequestId" placeholder="Request ID for approve/reject" style="min-width:280px">
      <input id="verificationAdminId" placeholder="Admin ID" style="width:140px">
      <input id="verificationAdminToken" placeholder="Admin token (if enabled)" style="min-width:200px">
      <input id="verificationAdminNote" placeholder="Admin note" style="min-width:200px">
      <button onclick="decideVerification('approve')">Approve</button>
      <button class="secondary" onclick="decideVerification('reject')">Reject</button>
    </div>
    <div id="verificationBox" class="mono" style="margin-top:10px;max-height:220px"></div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3>Media Upload Events</h3>
      <div id="mediaEvents" class="mono"></div>
    </div>
    <div class="panel">
      <h3>Notifications</h3>
      <div id="notifications" class="mono"></div>
    </div>
    <div class="panel">
      <h3>Followups</h3>
      <div id="followups" class="mono"></div>
    </div>
    <div class="panel">
      <h3>Monthly Report</h3>
      <div id="reportBox" class="mono"></div>
    </div>
    <div class="panel">
      <h3>Growth Incentives</h3>
      <div id="growthBox" class="mono"></div>
    </div>
    <div class="panel">
      <h3>Try-On Metrics</h3>
      <div id="tryonMetrics" class="mono"></div>
    </div>
  </div>
</div>

<script>
let autoRefresh = true;
let timer = null;

function fmtJson(value){
  return JSON.stringify(value || {}, null, 2);
}

function setStatus(text){
  document.getElementById("statusText").textContent = text || "";
}

function parseMonth(value){
  const raw = String(value || "").trim();
  if(/^\d{4}-\d{2}$/.test(raw)) return raw;
  const now = new Date();
  return `${now.getUTCFullYear()}-${String(now.getUTCMonth()+1).padStart(2,"0")}`;
}

function getApiBases(){
  const out = [""];
  const push = (raw) => {
    const val = String(raw || "").trim().replace(/\/+$/g,"");
    if(!val || !/^https?:\/\//i.test(val)) return;
    if(!out.includes(val)) out.push(val);
  };
  try{
    push(window.CONTEST_API_BASE);
    push(window.API_BASE);
    push(localStorage.getItem("contest_api_base"));
    push(localStorage.getItem("api_base"));
  }catch(_){ }
  if(/^https?:\/\//i.test(location.origin || "")) push(location.origin);
  push("https://novagapp-mart.onrender.com");
  return out;
}

async function apiGet(path){
  const bases = getApiBases();
  for(const base of bases){
    try{
      const res = await fetch(`${base}${path}`, { cache:"no-store" });
      if(!res.ok) continue;
      const payload = await res.json().catch(()=>null);
      if(payload) return payload;
    }catch(_){ }
  }
  return null;
}

async function apiSend(path, body, method){
  const bases = getApiBases();
  const verb = String(method || "POST").toUpperCase();
  for(const base of bases){
    try{
      const res = await fetch(`${base}${path}`, {
        method: verb,
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body || {})
      });
      const payload = await res.json().catch(()=>null);
      if(payload) return payload;
    }catch(_){ }
  }
  return null;
}

async function refreshEvents(){
  const payload = await apiGet("/api/admin/events?limit=40");
  document.getElementById("mediaEvents").textContent = fmtJson(payload?.events?.media_uploads || []);
  document.getElementById("notifications").textContent = fmtJson(payload?.events?.notifications || []);
  document.getElementById("followups").textContent = fmtJson(payload?.events?.followups || []);
  const metrics = await apiGet("/api/tryon/metrics");
  document.getElementById("tryonMetrics").textContent = fmtJson(metrics || { ok:false });
}

async function refreshReportAndGrowth(){
  const userId = String(document.getElementById("userIdInput").value || "").trim();
  const month = parseMonth(document.getElementById("monthInput").value);
  if(!userId){
    document.getElementById("reportBox").textContent = "Enter user id to view report.";
    document.getElementById("growthBox").textContent = "Enter user id to view growth incentives.";
    return;
  }
  const report = await apiGet(`/api/reports/monthly?user_id=${encodeURIComponent(userId)}&month=${encodeURIComponent(month)}`);
  const growth = await apiGet(`/api/growth/incentives?user_id=${encodeURIComponent(userId)}`);
  document.getElementById("reportBox").textContent = fmtJson(report || { ok:false });
  document.getElementById("growthBox").textContent = fmtJson(growth || { ok:false });
}

async function refreshVerificationPanel(){
  const userId = String(document.getElementById("userIdInput").value || "").trim();
  if(!userId){
    document.getElementById("verificationBox").textContent = "Enter user id to view verification status.";
    return;
  }
  const payload = await apiGet(`/api/verification/status?user_id=${encodeURIComponent(userId)}`);
  document.getElementById("verificationBox").textContent = fmtJson(payload || { ok:false });
  const requestId = String(payload?.verification?.request_id || "").trim();
  if(requestId && !document.getElementById("verificationRequestId").value){
    document.getElementById("verificationRequestId").value = requestId;
  }
}

async function submitVerificationRequest(){
  const userId = String(document.getElementById("userIdInput").value || "").trim();
  if(!userId){
    alert("Enter user id first.");
    return;
  }
  const kycCompleted = !!document.getElementById("verificationKyc").checked;
  const payload = await apiSend("/api/verification/request", {
    user_id: userId,
    followers_count: 0,
    kyc_completed: kycCompleted
  }, "POST");
  document.getElementById("verificationBox").textContent = fmtJson(payload || { ok:false });
  const requestId = String(payload?.verification?.request_id || "").trim();
  if(requestId){
    document.getElementById("verificationRequestId").value = requestId;
  }
}

async function decideVerification(decision){
  const requestId = String(document.getElementById("verificationRequestId").value || "").trim();
  if(!requestId){
    alert("Enter request id first.");
    return;
  }
  const adminId = String(document.getElementById("verificationAdminId").value || "").trim() || "admin";
  const adminNote = String(document.getElementById("verificationAdminNote").value || "").trim();
  const adminToken = String(document.getElementById("verificationAdminToken").value || "").trim();
  const body = {
    request_id: requestId,
    decision: String(decision || "").trim().toLowerCase(),
    admin_id: adminId,
    admin_note: adminNote
  };
  if(adminToken){
    body.admin_token = adminToken;
  }
  const payload = await apiSend("/api/admin/verification/decision", body, "POST");
  document.getElementById("verificationBox").textContent = fmtJson(payload || { ok:false });
  await refreshVerificationPanel();
}

async function refreshAll(){
  setStatus("Refreshing...");
  await Promise.all([
    refreshEvents(),
    refreshReportAndGrowth(),
    refreshVerificationPanel()
  ]);
  setStatus(`Updated at ${new Date().toLocaleString()}`);
}

function toggleAutoRefresh(){
  autoRefresh = !autoRefresh;
  const btn = document.getElementById("autoBtn");
  btn.textContent = autoRefresh ? "Auto: ON" : "Auto: OFF";
  if(autoRefresh){
    schedule();
  }else if(timer){
    clearTimeout(timer);
    timer = null;
  }
}

function schedule(){
  if(timer) clearTimeout(timer);
  if(!autoRefresh) return;
  timer = setTimeout(async () => {
    await refreshAll();
    schedule();
  }, 8000);
}

refreshAll().then(schedule);
</script>
</body>
</html>
