<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MVideo - NOVAGAPP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="public-config.js"></script>
<script src="social.js"></script>
<style>
:root{--bg:#fff;--tx:#111;--mut:#666;--line:#e8e8e8;--soft:#f4f4f4;--acc:#ff6a00}
*{box-sizing:border-box}body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--tx)}
.profile-bar{padding:12px 10px 6px;display:flex;gap:10px;align-items:center}
.profile-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(45deg,#ff6a00,#ff2d55);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.profile-meta small{color:var(--mut)}
.search-bar{position:sticky;top:0;background:#fff;padding:10px;border-bottom:1px solid var(--line);z-index:12}
.search-bar input{width:100%;padding:12px 14px;border-radius:24px;border:1px solid #d2d2d2;font-size:14px;outline:none}
.feed{max-width:760px;margin:0 auto;padding:12px 10px 84px}
.feed-empty{max-width:760px;margin:14px auto 90px;padding:0 14px;text-align:center;font-size:14px;color:var(--mut)}
.video-card{border:1px solid var(--line);border-radius:16px;overflow:hidden;margin-bottom:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.04)}
.thumb-btn{border:none;width:100%;padding:0;aspect-ratio:16/9;position:relative;display:block;background:#000;cursor:pointer;overflow:hidden}
.thumb-btn img{width:100%;height:100%;object-fit:cover}
.thumb-fallback{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;background:radial-gradient(circle at 20% 20%,#3a3a3a,#111)}
.play-badge{position:absolute;right:10px;bottom:10px;background:rgba(0,0,0,.72);color:#fff;font-size:11px;padding:4px 8px;border-radius:999px}
.video-info{padding:10px 12px 12px}
.video-info h4{margin:0 0 6px;font-size:15px;line-height:1.35}
.video-sub{font-size:12px;color:var(--mut)}
.detail-pane{position:fixed;inset:0;background:#fff;z-index:45;transform:translateY(100%);transition:transform .22s ease;display:flex;flex-direction:column}
.detail-pane.show{transform:translateY(0)}
.detail-header{height:46px;display:flex;align-items:center;justify-content:space-between;padding:0 8px;border-bottom:1px solid var(--line)}
.ghost-btn{border:none;background:var(--soft);height:30px;padding:0 12px;border-radius:999px;cursor:pointer;font-size:12px}
.detail-header-title{font-weight:700;font-size:13px}
.detail-player{width:100%;min-height:40vh;max-height:40vh;background:#000;display:flex;align-items:center;justify-content:center}
.detail-player video{width:100%;max-height:40vh;aspect-ratio:16/9;object-fit:contain;background:#000}
.detail-tools{display:flex;justify-content:flex-end;align-items:center;padding:7px 10px;border-bottom:1px solid var(--line)}
.desc-toggle{border:none;background:var(--soft);color:#333;height:30px;padding:0 12px;border-radius:999px;font-size:12px;cursor:pointer}
.detail-actions{min-height:60px;border-bottom:1px solid var(--line);display:grid;grid-template-columns:repeat(6,minmax(0,1fr));padding:8px 4px;gap:2px}
.action-item{border:none;background:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:4px 0;cursor:pointer;color:#222}
.action-item svg{width:19px;height:19px;fill:#222}
.action-item.active svg{fill:var(--acc)}
.action-count{font-size:11px;color:#444;min-height:12px}
.action-label{font-size:10px;color:#666}
.detail-channel{border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;padding:9px 12px}
.channel-avatar{width:36px;height:36px;border-radius:50%;overflow:hidden;flex-shrink:0;background:linear-gradient(45deg,#ff6a00,#ff2d55);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.channel-avatar img{width:100%;height:100%;object-fit:cover}
.channel-meta{min-width:0;flex:1}
.channel-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.channel-meta small{font-size:11px;color:var(--mut)}
.follow-btn{border:none;border-radius:999px;padding:7px 12px;font-size:12px;cursor:pointer;background:var(--acc);color:#fff}
.follow-btn.following{background:#a9a9a9}
.detail-comment-row{padding:8px 12px;border-bottom:1px solid var(--line)}
.comment-view-btn{border:none;background:none;color:#0d63c7;font-size:12px;cursor:pointer;padding:0}
.detail-meta{padding:10px 12px;border-bottom:1px solid var(--line)}
.detail-meta h3{margin:0 0 5px;font-size:15px}
.detail-meta p{margin:0;color:#565;font-size:13px;line-height:1.35;white-space:pre-wrap;word-break:break-word}
.detail-meta[hidden]{display:none}
.rec-head{font-size:12px;font-weight:700;color:#555;padding:8px 12px 2px}
.recommend{flex:1;overflow-y:auto;padding:6px 12px 92px}
.rec-card{border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-bottom:10px;background:#fff;cursor:pointer}
.rec-thumb{width:100%;aspect-ratio:16/9;background:#000}
.rec-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.rec-body{padding:8px 10px 10px}
.rec-body h5{margin:0 0 4px;font-size:13px;line-height:1.35}
.rec-body small{font-size:11px;color:var(--mut)}
.mini{position:fixed;width:min(40vw,220px);min-width:150px;aspect-ratio:16/9;right:12px;bottom:76px;background:#000;border-radius:12px;overflow:hidden;box-shadow:0 10px 28px rgba(0,0,0,.28);z-index:60;touch-action:none}
.mini video{width:100%;height:100%;object-fit:cover}
.mini-ctrl{position:absolute;left:6px;right:6px;bottom:6px;display:flex;justify-content:space-between;gap:6px}
.mini-ctrl button{border:none;background:rgba(0,0,0,.65);color:#fff;border-radius:999px;padding:5px 9px;font-size:10px;cursor:pointer}
.comments-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:71}
.comments-bg.show{display:block}
.comments{position:fixed;left:0;right:0;bottom:-82vh;max-height:72vh;background:#fff;border-radius:16px 16px 0 0;z-index:72;display:flex;flex-direction:column;transition:bottom .22s ease}
.comments.show{bottom:0}
.com-head{border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;padding:10px 12px;font-size:13px;font-weight:700}
.com-head button{border:none;background:#111;color:#fff;border-radius:999px;padding:5px 10px;font-size:11px;cursor:pointer}
.com-list{flex:1;overflow-y:auto;padding:10px 12px}
.com-row{display:flex;gap:10px;padding:8px 0}
.com-row+.com-row{border-top:1px solid #f0f0f0}
.com-avatar{width:30px;height:30px;border-radius:50%;overflow:hidden;flex-shrink:0;background:linear-gradient(45deg,#ff6a00,#ff2d55);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
.com-avatar img{width:100%;height:100%;object-fit:cover}
.com-body{min-width:0;flex:1}
.com-meta{display:flex;gap:8px;align-items:center}
.com-meta strong{font-size:12px}
.com-meta span{font-size:10px;color:#777}
.com-text{margin-top:2px;font-size:13px;white-space:pre-wrap;word-break:break-word}
.com-empty{text-align:center;font-size:12px;color:#666;padding:12px}
.com-input{border-top:1px solid var(--line);display:flex;gap:8px;padding:10px 12px}
.com-input input{flex:1;border:1px solid #d9d9d9;border-radius:999px;padding:10px 12px;font-size:13px}
.com-input button{border:none;background:var(--acc);color:#fff;border-radius:999px;padding:0 14px;cursor:pointer;font-size:12px}
.nav{position:fixed;bottom:0;left:0;width:100%;height:60px;background:#111;display:flex;z-index:20}
.nav div{flex:1;display:flex;align-items:center;justify-content:center}
.nav svg{width:24px;height:24px;fill:#888}
.nav .active svg{fill:#ff6a00}
</style>
</head>
<body>
<div class="profile-bar"><div class="profile-avatar" id="avatar">U</div><div class="profile-meta"><div id="displayName">User</div><small id="handle">@user</small></div></div>
<div class="search-bar"><input type="text" id="searchInput" placeholder="Search videos by title..."></div>
<div class="feed" id="feed"></div>
<div class="feed-empty" id="feedEmpty" hidden>No videos found.</div>
<div id="sentinel"></div>

<div class="detail-pane" id="detailPane" aria-hidden="true">
  <div class="detail-header"><button class="ghost-btn" id="backBtn" type="button">Back</button><div class="detail-header-title">Long Video</div><button class="ghost-btn" id="miniBtn" type="button">Mini</button></div>
  <div class="detail-player"><video id="detailVideo" playsinline controls></video></div>
  <div class="detail-tools"><button class="desc-toggle" id="btnDescToggle" type="button">Description</button></div>
  <div class="detail-meta" id="detailMeta" hidden><h3 id="detailTitle">Long Video</h3><p id="detailDesc"></p></div>
  <div class="detail-actions">
    <button class="action-item" id="btnLike" type="button"><svg viewBox="0 0 24 24"><path d="M12 21s-6.7-4.35-9.33-7.58C.4 10.68 1.3 6.5 5 5.5c2-.54 4 .3 5 1.5 1-1.2 3-2.04 5-1.5 3.7 1 4.6 5.18 2.33 7.92C18.7 16.65 12 21 12 21z"/></svg><span class="action-count" id="countLike">0</span><span class="action-label">Like</span></button>
    <button class="action-item" id="btnDislike" type="button"><svg viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22L2 9v2h6v9l7.31-7.31c.37-.37.69-.81.94-1.28l1.75-3.49c.11-.23.18-.49.18-.76V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg><span class="action-count" id="countDislike">0</span><span class="action-label">Dislike</span></button>
    <button class="action-item" id="btnComment" type="button"><svg viewBox="0 0 24 24"><path d="M21 6h-18v12h4v4l4-4h10z"/></svg><span class="action-count" id="countComment">0</span><span class="action-label">Comment</span></button>
    <button class="action-item" id="btnShare" type="button"><svg viewBox="0 0 24 24"><path d="M12 3l9 9-9 9-9-9 9-9z"/></svg><span class="action-count" id="countShare">0</span><span class="action-label">Share</span></button>
    <button class="action-item" id="btnSave" type="button"><svg viewBox="0 0 24 24"><path d="M17 3H7a2 2 0 0 0-2 2v16l7-3 7 3V5a2 2 0 0 0-2-2z"/></svg><span class="action-count">&nbsp;</span><span class="action-label">Save</span></button>
    <button class="action-item" id="btnFull" type="button"><svg viewBox="0 0 24 24"><path d="M7 14h-2v7h7v-2H7v-5zm0-4h2V5h5V3H5v7zm10 9h-5v2h7v-7h-2v5zm0-16v2h5v5h2V3h-7z"/></svg><span class="action-count">&nbsp;</span><span class="action-label">Full</span></button>
  </div>
  <div class="detail-channel" id="channelRow"><div class="channel-avatar" id="channelAvatar">U</div><div class="channel-meta"><div class="channel-name" id="channelName">User</div><small id="channelSub">0 followers . 0 views</small></div><button class="follow-btn" id="followBtn" type="button">Follow</button></div>
  <div class="detail-comment-row"><button class="comment-view-btn" id="btnCommentView" type="button">Comment (View <span id="commentViewCount">0</span>)</button></div>
  <div class="rec-head">Recommended videos</div>
  <div class="recommend" id="recommend"></div>
</div>

<div class="mini" id="mini" hidden><video id="miniVideo" playsinline></video><div class="mini-ctrl"><button id="miniExpand" type="button">Expand</button><button id="miniClose" type="button">Close</button></div></div>
<div class="comments-bg" id="commentsBg"></div>
<div class="comments" id="comments">
  <div class="com-head"><span>Comments</span><button id="commentsClose" type="button">Close</button></div>
  <div class="com-list" id="commentsList"></div>
  <div class="com-input"><input type="text" id="commentInput" placeholder="Add a comment"><button id="commentSend" type="button">Send</button></div>
</div>
<input type="file" id="videoInput" accept="video/*" hidden>

<div class="nav">
  <div onclick="go('index.html')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3l-10-9-10 9h3v8z"/></svg></div>
  <div onclick="go('post.html')"><svg viewBox="0 0 24 24"><path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6z"/></svg></div>
  <div onclick="go('m-subcription.html')"><svg viewBox="0 0 24 24"><path d="M12 2l9 4.5v6c0 5-4 9.5-9 9.5s-9-4.5-9-9.5v-6z"/></svg></div>
  <div onclick="go('watch-history.html')"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 1 0 8.95 10h-2.02a7 7 0 1 1-1.7-5.3L15 11h6V5l-2.35 2.35A8.96 8.96 0 0 0 13 3z"/></svg></div>
  <div class="active"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
</div>

<script>
const $=id=>document.getElementById(id);
const feed=$("feed"),feedEmpty=$("feedEmpty"),sentinel=$("sentinel"),searchInput=$("searchInput"),videoInput=$("videoInput");
const detailPane=$("detailPane"),detailVideo=$("detailVideo"),backBtn=$("backBtn"),miniBtn=$("miniBtn"),btnLike=$("btnLike"),btnDislike=$("btnDislike"),btnComment=$("btnComment"),btnShare=$("btnShare"),btnSave=$("btnSave"),btnFull=$("btnFull"),btnDescToggle=$("btnDescToggle"),detailMeta=$("detailMeta"),btnCommentView=$("btnCommentView");
const countLike=$("countLike"),countDislike=$("countDislike"),countComment=$("countComment"),countShare=$("countShare"),commentViewCount=$("commentViewCount"),detailTitle=$("detailTitle"),detailDesc=$("detailDesc"),channelRow=$("channelRow"),channelAvatar=$("channelAvatar"),channelName=$("channelName"),channelSub=$("channelSub"),followBtn=$("followBtn"),recommend=$("recommend");
const mini=$("mini"),miniVideo=$("miniVideo"),miniExpand=$("miniExpand"),miniClose=$("miniClose");
const commentsBg=$("commentsBg"),comments=$("comments"),commentsClose=$("commentsClose"),commentsList=$("commentsList"),commentInput=$("commentInput"),commentSend=$("commentSend");
const displayName=$("displayName"),handle=$("handle"),avatar=$("avatar");

const params=new URLSearchParams(location.search),feedUserId=params.get("uid")||"",focusId=params.get("focus")||"",SAVE_KEY="nova_saved_long_videos",VIEW_KEY="nova_long_views_",PAGE_SIZE=8;
let me=null,page=0,loading=false,done=false,searchQuery="",mode="feed",active=null,activeReaction=null,reactionBusy=false,activeFollow=false,activeFollowers=0,focusApplied=false,searchTimer=null,startX=0,startY=0;
const rendered=new Set(),items=[],map=new Map(),cards=new Map(),creatorCache={},followersCache={},sessionViews=new Set();
let saved=loadSaved();

function hasNova(){return !!(window.NOVA&&window.NOVA.supa&&typeof window.NOVA.getUser==="function")}
async function waitNova(ms=4500){const s=Date.now();while(Date.now()-s<ms){if(hasNova())return true;await new Promise(r=>setTimeout(r,50))}return hasNova()}
function esc(v){return String(v||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}
function fmt(n){return new Intl.NumberFormat("en-US").format(Math.max(0,Number(n)||0))}
function compact(n){n=Number(n)||0;if(n>=1e6)return(n/1e6).toFixed(1).replace(/\.0$/,'')+'M';if(n>=1e3)return(n/1e3).toFixed(1).replace(/\.0$/,'')+'K';return String(n)}
function readCount(el){return Number(String(el.textContent||"0").replace(/,/g,""))||0}
function shuffle(arr){arr=(Array.isArray(arr)?arr.slice():[]);for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
function viewCount(id){id=String(id||"");if(!id)return 0;return Math.max(0,Number(localStorage.getItem(VIEW_KEY+id))||0)}
function markView(id){id=String(id||"");if(!id)return 0;if(sessionViews.has(id))return viewCount(id);sessionViews.add(id);const n=viewCount(id)+1;localStorage.setItem(VIEW_KEY+id,String(n));return n}
function loadSaved(){try{const a=JSON.parse(localStorage.getItem(SAVE_KEY)||"[]");return new Set((Array.isArray(a)?a:[]).map(v=>String(v||"")))}catch{return new Set()}}
function persistSaved(){localStorage.setItem(SAVE_KEY,JSON.stringify(Array.from(saved)))}
function normalizeKeywords(raw){const t=String(raw||"").trim();if(!t)return null;if(!t.includes(","))return t;const list=t.split(",").map(s=>s.trim()).filter(Boolean);return list.length?list.join(", "):null}
function getSupabaseErrorText(error){return [error?.message,error?.details,error?.hint].filter(Boolean).join(" ")}
function getMissingColumnName(error){
  const text=getSupabaseErrorText(error);
  if(!text) return "";
  const pgrstMatch=text.match(/'([a-zA-Z0-9_]+)' column/i);
  if(pgrstMatch&&pgrstMatch[1]) return pgrstMatch[1].toLowerCase();
  const pgMatch=text.match(/column\s+\"?([a-zA-Z0-9_.]+)\"?\s+does not exist/i);
  if(pgMatch&&pgMatch[1]){
    const normalized=pgMatch[1].replace(/\"/g,"").toLowerCase();
    return normalized.split(".").pop()||"";
  }
  return "";
}
async function insertLongVideoPublic(payload){
  const row={...(payload||{}),is_public:true,visibility:"public",public:true};
  const required=new Set(Object.keys(payload||{}).map(k=>String(k||"").toLowerCase()));
  while(true){
    const {error}=await window.NOVA.supa.from("long_videos").insert(row);
    if(!error) return;
    const missing=getMissingColumnName(error);
    if(!missing||!Object.prototype.hasOwnProperty.call(row,missing)||required.has(missing)){
      throw error;
    }
    delete row[missing];
  }
}
function setMode(m){mode=String(m||"feed");if(mode==="detail"){detailPane.classList.add("show");detailPane.setAttribute("aria-hidden","false");mini.hidden=true;return}if(mode==="mini"){detailPane.classList.remove("show");detailPane.setAttribute("aria-hidden","true");mini.hidden=false;return}detailPane.classList.remove("show");detailPane.setAttribute("aria-hidden","true");mini.hidden=true}
function setReactionUi(r){btnLike.classList.toggle("active",r==="like");btnDislike.classList.toggle("active",r==="dislike")}
function setFollowUi(){if(!active){followBtn.textContent="Follow";followBtn.classList.remove("following");followBtn.disabled=true;return}if(me&&me.id&&String(me.id)===String(active.user_id)){followBtn.textContent="You";followBtn.classList.remove("following");followBtn.disabled=true;return}followBtn.disabled=false;followBtn.textContent=activeFollow?"Followed":"Follow";followBtn.classList.toggle("following",activeFollow)}
function renderSaveUi(){if(!active){btnSave.classList.remove("active");return}btnSave.classList.toggle("active",saved.has(String(active.id)))}
function renderChannelSub(){if(!active){channelSub.textContent="0 followers . 0 views";return}channelSub.textContent=`${compact(activeFollowers)} followers . ${fmt(viewCount(active.id))} views`}
function setDescriptionVisible(show){detailMeta.hidden=!show}
function syncCommentViewCount(){commentViewCount.textContent=countComment.textContent||"0"}
function fmtAgo(v){const t=Date.parse(String(v||""));if(!Number.isFinite(t))return "";const d=Math.max(1,Math.floor((Date.now()-t)/1000));if(d<60)return d+"s";if(d<3600)return Math.floor(d/60)+"m";if(d<86400)return Math.floor(d/3600)+"h";if(d<604800)return Math.floor(d/86400)+"d";return new Date(t).toLocaleDateString(undefined,{month:"short",day:"numeric"})}
async function creator(uid){
  const k=String(uid||"");
  if(!k) return {name:"User",avatar:""};
  if(creatorCache[k]) return creatorCache[k];
  try{
    const {data}=await window.NOVA.supa.from("users").select("username,full_name,photo").eq("user_id",k).maybeSingle();
    const info={name:String(data?.full_name||data?.username||"User"),avatar:String(data?.photo||"")};
    creatorCache[k]=info;
    return info;
  }catch{
    creatorCache[k]={name:"User",avatar:""};
    return creatorCache[k];
  }
}

async function followerCount(uid){
  const k=String(uid||"");
  if(!k) return 0;
  if(Object.prototype.hasOwnProperty.call(followersCache,k)) return followersCache[k];
  try{
    const {count}=await window.NOVA.supa.from("follows").select("follower_id",{count:"exact",head:true}).eq("following_id",k);
    followersCache[k]=Number(count||0);
    return followersCache[k];
  }catch{
    followersCache[k]=0;
    return 0;
  }
}

function addItem(item){
  if(!item||!item.id) return;
  const k=String(item.id);
  if(map.has(k)){ map.set(k,{...map.get(k),...item}); return; }
  map.set(k,item);
  items.push(item);
}

function updateFeedSub(id){
  id=String(id||"");
  const ref=cards.get(id);
  if(!ref||!map.has(id)) return;
  const it=map.get(id);
  creator(it.user_id).then(c=>{
    ref.text.textContent=`${c.name} . ${fmt(viewCount(id))} views`;
  });
}

async function renderCard(item,opts){
  if(!item||!item.id) return;
  const k=String(item.id);
  if(rendered.has(k)) return;
  rendered.add(k);
  addItem(item);

  const thumb=item.thumb_url?`<img src="${esc(item.thumb_url)}" alt="">`:`<div class="thumb-fallback">No thumbnail</div>`;
  const card=document.createElement("div");
  card.className="video-card";
  card.dataset.id=k;
  card.innerHTML=`<button class="thumb-btn" data-open type="button">${thumb}<span class="play-badge">Tap to play</span></button><div class="video-info"><h4>${esc(item.title||"Long Video")}</h4><div class="video-sub" data-sub>Loading...</div></div>`;

  const text=card.querySelector("[data-sub]");
  cards.set(k,{card,text});
  card.querySelector("[data-open]").addEventListener("click",()=>openDetail(k,{push:true,play:true}));

  if(opts?.prepend&&feed.firstChild) feed.insertBefore(card,feed.firstChild);
  else feed.appendChild(card);

  updateFeedSub(k);
  if(focusId&&k===String(focusId)&&!focusApplied){
    focusApplied=true;
    openDetail(k,{push:false,play:true});
  }
}

async function loadMore(){
  if(loading||done) return;
  loading=true;
  const ready=await waitNova();
  if(!ready){
    done=true;
    loading=false;
    feedEmpty.hidden=false;
    feedEmpty.textContent="Unable to load videos right now.";
    return;
  }

  let q=window.NOVA.supa
    .from("long_videos")
    .select("id,user_id,video_url,thumb_url,title,description,created_at")
    .order("created_at",{ascending:false})
    .range(page*PAGE_SIZE,page*PAGE_SIZE+PAGE_SIZE-1);

  if(feedUserId) q=q.eq("user_id",feedUserId);
  if(searchQuery) q=q.ilike("title",`%${searchQuery}%`);

  const {data,error}=await q;
  if(error){
    console.error(error);
    loading=false;
    if(!items.length){
      feedEmpty.hidden=false;
      feedEmpty.textContent="Unable to load videos.";
    }
    return;
  }

  const rows=shuffle(data||[]);
  if(!rows.length){
    done=true;
    loading=false;
    if(!items.length){
      feedEmpty.hidden=false;
      feedEmpty.textContent="No videos found.";
    }
    return;
  }

  feedEmpty.hidden=true;
  for(const it of rows) await renderCard(it);
  page+=1;
  loading=false;
}

async function ensureFocus(){
  if(!focusId||map.has(String(focusId))) return;
  let q=window.NOVA.supa.from("long_videos").select("id,user_id,video_url,thumb_url,title,description,created_at").eq("id",focusId).maybeSingle();
  if(feedUserId) q=q.eq("user_id",feedUserId);
  const {data,error}=await q;
  if(!error&&data?.id) await renderCard(data,{prepend:true});
}

async function setVideo(video,time,play){
  time=Math.max(0,Number(time)||0);
  const apply=()=>{ if(time>0){ try{video.currentTime=time;}catch{} } if(play!==false) video.play().catch(()=>{}); };
  if(video.readyState>=1){ apply(); return; }
  await new Promise(r=>video.addEventListener("loadedmetadata",r,{once:true}));
  apply();
}

async function hydrateDetail(it){
  const c=await window.NOVA.getReactionCounts("long",it.id);
  const cc=await window.NOVA.getCommentCount("long",it.id);
  const sc=await window.NOVA.getShareCount("long",it.id);

  countLike.textContent=fmt(c.likes);
  countDislike.textContent=fmt(c.dislikes);
  countComment.textContent=fmt(cc);
  countShare.textContent=fmt(sc);
  syncCommentViewCount();

  activeReaction=null;
  activeFollow=false;
  setReactionUi(null);

  if(me&&me.id){
    try{
      const {data}=await window.NOVA.supa.from("reactions").select("reaction").eq("user_id",me.id).eq("target_type","long").eq("target_id",it.id).maybeSingle();
      activeReaction=data?.reaction||null;
      setReactionUi(activeReaction);
    }catch{}

    if(String(me.id)!==String(it.user_id)){
      try{
        const {data}=await window.NOVA.supa.from("follows").select("following_id").eq("follower_id",me.id).eq("following_id",it.user_id).maybeSingle();
        activeFollow=!!data;
      }catch{ activeFollow=false; }
    }
  }

  setFollowUi();
}
async function renderRecommend(activeId){
  const list=shuffle(items.filter(x=>String(x.id)!==String(activeId||""))).slice(0,16);
  if(!list.length){
    recommend.innerHTML="<div class='com-empty'>No recommendations yet.</div>";
    return;
  }
  recommend.innerHTML="";
  for(const it of list){
    const c=await creator(it.user_id);
    const el=document.createElement("div");
    el.className="rec-card";
    el.dataset.id=String(it.id||"");
    el.innerHTML=`<div class="rec-thumb">${it.thumb_url?`<img src="${esc(it.thumb_url)}" alt="">`:`<div class="thumb-fallback">No thumbnail</div>`}</div><div class="rec-body"><h5>${esc(it.title||"Long Video")}</h5><small>${esc(c.name)} . ${fmt(viewCount(it.id))} views</small></div>`;
    el.addEventListener("click",()=>{ openDetail(it.id,{push:true,play:true}); recommend.scrollTop=0; });
    recommend.appendChild(el);
  }
}

async function openDetail(id,opt){
  id=String(id||"");
  if(!map.has(id)) return;
  const it=map.get(id);
  active=it;
  reactionBusy=false;

  detailTitle.textContent=it.title||"Long Video";
  detailDesc.textContent=it.description||"";
  setDescriptionVisible(false);
  channelName.textContent="User";
  channelAvatar.innerHTML="U";

  if(detailVideo.src!==it.video_url) detailVideo.src=it.video_url;
  detailVideo.poster=it.thumb_url||"";
  setMode("detail");

  const c=await creator(it.user_id);
  channelName.textContent=c.name;
  channelAvatar.innerHTML=c.avatar?`<img src="${esc(c.avatar)}" alt="">`:esc((c.name||"U")[0].toUpperCase());

  activeFollowers=await followerCount(it.user_id);
  renderChannelSub();
  await hydrateDetail(it);
  renderSaveUi();
  await renderRecommend(it.id);

  await setVideo(detailVideo,opt?.start||0,opt?.play!==false);
  markView(it.id);
  renderChannelSub();
  updateFeedSub(it.id);
  await renderRecommend(it.id);

  if(opt?.push!==false) history.pushState({mode:"detail",videoId:id},"",location.href);
}

function closeDetail(){ detailVideo.pause(); setMode("feed"); }

function miniDown(){
  if(!active) return;
  const at=Number(detailVideo.currentTime)||0;
  const paused=detailVideo.paused;
  if(miniVideo.src!==active.video_url) miniVideo.src=active.video_url;
  miniVideo.poster=active.thumb_url||"";
  setMode("mini");
  setVideo(miniVideo,at,!paused);
  detailVideo.pause();
}

function miniUp(push){
  if(!active) return;
  const at=Number(miniVideo.currentTime)||0;
  const paused=miniVideo.paused;
  miniVideo.pause();
  openDetail(active.id,{start:at,play:!paused,push:!!push});
}

function closeMini(){ miniVideo.pause(); setMode("feed"); }

async function ensureLogin(){
  if(me&&me.id) return true;
  try{ me=await window.NOVA.requireUser(); await hydrateProfile(); return true; }
  catch{ return false; }
}

function reactDelta(prev,next){
  let l=readCount(countLike),d=readCount(countDislike);
  if(prev==="like") l=Math.max(0,l-1);
  if(prev==="dislike") d=Math.max(0,d-1);
  if(next==="like") l++;
  if(next==="dislike") d++;
  countLike.textContent=fmt(l);
  countDislike.textContent=fmt(d);
}

async function refreshReactions(){
  if(!active) return;
  const c=await window.NOVA.getReactionCounts("long",active.id);
  countLike.textContent=fmt(c.likes);
  countDislike.textContent=fmt(c.dislikes);
}

async function toggleReaction(type){
  if(!active||reactionBusy) return;
  if(!(await ensureLogin())) return;
  reactionBusy=true;
  const prev=activeReaction;
  try{
    const res=await window.NOVA.toggleReaction("long",active.id,type);
    const p=(res&&Object.prototype.hasOwnProperty.call(res,"previousReaction"))?(res.previousReaction||null):prev;
    const n=(res&&Object.prototype.hasOwnProperty.call(res,"reaction"))?(res.reaction||null):(res&&res.active?type:null);
    reactDelta(p,n);
    activeReaction=n;
    setReactionUi(activeReaction);
    await refreshReactions();
  }catch(e){
    console.error(e);
    await refreshReactions();
    setReactionUi(activeReaction);
  }finally{ reactionBusy=false; }
}

async function toggleFollow(){
  if(!active) return;
  if(!(await ensureLogin())) return;
  if(String(me.id)===String(active.user_id)) return;
  followBtn.disabled=true;
  const prev=!!activeFollow;
  try{
    const res=await window.NOVA.toggleFollow(active.user_id);
    const next=typeof res?.following==="boolean"?res.following:!prev;
    if(next!==prev){
      activeFollowers=Math.max(0,activeFollowers+(next?1:-1));
      followersCache[String(active.user_id)]=activeFollowers;
    }
    activeFollow=next;
    setFollowUi();
    renderChannelSub();
  }finally{ followBtn.disabled=false; }
}

async function refreshCommentCount(){
  if(!active) return;
  countComment.textContent=fmt(await window.NOVA.getCommentCount("long",active.id));
  syncCommentViewCount();
}

async function openComments(){
  if(!active) return;
  commentsBg.classList.add("show");
  comments.classList.add("show");
  commentsList.innerHTML="<div class='com-empty'>Loading comments...</div>";

  try{
    const t=await window.NOVA.getCommentThread("long",active.id,{limit:300});
    const flat=Array.isArray(t?.flat)?t.flat.slice():[];
    if(!flat.length){ commentsList.innerHTML="<div class='com-empty'>No comments yet.</div>"; return; }

    flat.sort((a,b)=>(Date.parse(String(a?.created_at||""))||0)-(Date.parse(String(b?.created_at||""))||0));
    commentsList.innerHTML="";
    for(const r of flat){
      const c=await creator(r.user_id);
      const av=c.avatar?`<img src="${esc(c.avatar)}" alt="">`:esc((c.name||"U")[0].toUpperCase());
      const row=document.createElement("div");
      row.className="com-row";
      row.innerHTML=`<div class="com-avatar">${av}</div><div class="com-body"><div class="com-meta"><strong>${esc(c.name)}</strong><span>${esc(fmtAgo(r.created_at))}</span></div><div class="com-text">${esc(r.body||"")}</div></div>`;
      commentsList.appendChild(row);
    }
  }catch{
    commentsList.innerHTML="<div class='com-empty'>Unable to load comments.</div>";
  }
}
function closeComments(){
  comments.classList.remove("show");
  commentsBg.classList.remove("show");
  commentInput.value="";
}

async function sendComment(){
  if(!active) return;
  const txt=String(commentInput.value||"").trim();
  if(!txt) return;
  if(!(await ensureLogin())) return;
  commentSend.disabled=true;
  const ok=await window.NOVA.addComment("long",active.id,txt);
  commentSend.disabled=false;
  if(!ok) return;
  commentInput.value="";
  await refreshCommentCount();
  await openComments();
}

async function doShare(){
  if(!active) return;
  const text=active.title||"Long Video";
  const url=new URL("m-video.html",location.href);
  if(active.user_id) url.searchParams.set("uid",active.user_id);
  url.searchParams.set("focus",active.id);

  let shared=false,channel="native";
  try{
    if(navigator.share){
      await navigator.share({title:"NOVAGAPP",text,url:url.href});
      shared=true;
    }
  }catch(e){
    if(!(e&&e.name==="AbortError")) shared=false;
  }

  if(!shared){
    try{
      if(navigator.clipboard&&navigator.clipboard.writeText){
        await navigator.clipboard.writeText(url.href);
        shared=true;
        channel="copy";
        alert("Link copied:\n"+url.href);
      }
    }catch{}
  }

  if(!shared){
    try{ window.prompt("Copy this link",url.href); shared=true; channel="manual"; }
    catch{}
  }

  if(shared){
    try{
      await window.NOVA.trackShare("long",active.id,channel);
      countShare.textContent=fmt(await window.NOVA.getShareCount("long",active.id));
    }catch{}
  }
}

function toggleSave(){
  if(!active) return;
  const k=String(active.id||"");
  if(!k) return;
  if(saved.has(k)) saved.delete(k); else saved.add(k);
  persistSaved();
  renderSaveUi();
}

async function hydrateProfile(){
  const fallback=me?.email?String(me.email).split("@")[0]:"guest";
  let handleText=fallback||"guest",name=me?.user_metadata?.full_name||"";
  if(me&&me.id){
    try{
      const {data}=await window.NOVA.supa.from("users").select("username,full_name").eq("user_id",me.id).maybeSingle();
      if(data?.username) handleText=data.username;
      if(data?.full_name) name=data.full_name;
    }catch{}
  }
  displayName.textContent=name||handleText||"Guest";
  handle.textContent="@"+(handleText||"guest");
  avatar.textContent=(handleText||"G")[0].toUpperCase();
}

async function openUpload(){
  if(!(await ensureLogin())) return;
  videoInput.click();
}

videoInput.onchange=async e=>{
  const file=e.target.files&&e.target.files[0];
  videoInput.value="";
  if(!file) return;
  if(!(await ensureLogin())) return;

  try{
    const meta=await window.NOVA.getVideoMeta(file);
    if(!window.NOVA.validateAspect(meta.width,meta.height,16/9,0.2)){
      alert("Long video should be 16:9.");
      return;
    }

    const info=await window.NOVA.askMeta();
    const path=window.NOVA.makePath(me.id,file);
    const videoUrl=await window.NOVA.uploadToBucket("long_videos",file,path);

    await insertLongVideoPublic({
      user_id:me.id,
      video_url:videoUrl,
      thumb_url:info.thumbUrl||null,
      title:info.title||null,
      description:info.description||null,
      keywords:normalizeKeywords(info.keywords),
      duration:Math.round(meta.duration),
      width:meta.width,
      height:meta.height
    });

    alert("Video uploaded and published.");
    location.href="m-video.html";
  }catch(err){
    console.error("Long video upload failed",err);
    alert("Unable to upload this video right now. Please try again.");
  }
};

function resetFeed(){
  page=0; loading=false; done=false; focusApplied=false;
  feed.innerHTML=""; feedEmpty.hidden=true;
  rendered.clear(); items.length=0; map.clear(); cards.clear();
}

function wire(){
  btnLike.onclick=()=>toggleReaction("like");
  btnDislike.onclick=()=>toggleReaction("dislike");
  btnDescToggle.onclick=()=>setDescriptionVisible(detailMeta.hidden);
  btnComment.onclick=openComments;
  btnCommentView.onclick=openComments;
  btnShare.onclick=doShare;
  btnSave.onclick=toggleSave;
  btnFull.onclick=()=>{ if(detailVideo.requestFullscreen) detailVideo.requestFullscreen().catch(()=>{}); };
  followBtn.onclick=e=>{ e.stopPropagation(); toggleFollow(); };
  channelRow.onclick=()=>{ if(active&&active.user_id) location.href="m-account.html?uid="+encodeURIComponent(active.user_id); };
  backBtn.onclick=closeDetail;
  miniBtn.onclick=miniDown;
  miniExpand.onclick=()=>miniUp(true);
  miniClose.onclick=closeMini;
  commentsClose.onclick=closeComments;
  commentsBg.onclick=closeComments;
  commentSend.onclick=sendComment;
  commentInput.onkeydown=e=>{ if(e.key==="Enter"){ e.preventDefault(); sendComment(); } };
  searchInput.oninput=e=>{ clearTimeout(searchTimer); searchTimer=setTimeout(()=>{ searchQuery=String(e.target.value||"").trim(); resetFeed(); loadMore(); },250); };
  detailVideo.addEventListener("pointerdown",e=>{ startX=e.clientX; startY=e.clientY; });
  detailVideo.addEventListener("pointerup",e=>{ const dx=Math.abs(e.clientX-startX),dy=e.clientY-startY; if(dy>80&&dx<70) miniDown(); });
  window.addEventListener("popstate",e=>{ const st=e.state||{}; if(st.mode==="detail"&&st.videoId){ if(map.has(String(st.videoId))) openDetail(st.videoId,{push:false,play:false}); return; } if(mode==="detail") detailVideo.pause(); if(mode==="mini") miniVideo.pause(); setMode("feed"); });
}

const drag={on:false,moved:false,id:0,sx:0,sy:0,l:0,t:0};
mini.addEventListener("pointerdown",e=>{ if(e.target.closest(".mini-ctrl")) return; drag.on=true; drag.moved=false; drag.id=e.pointerId; drag.sx=e.clientX; drag.sy=e.clientY; const r=mini.getBoundingClientRect(); drag.l=r.left; drag.t=r.top; mini.setPointerCapture(e.pointerId); });
mini.addEventListener("pointermove",e=>{ if(!drag.on||e.pointerId!==drag.id) return; const dx=e.clientX-drag.sx,dy=e.clientY-drag.sy; if(Math.abs(dx)>4||Math.abs(dy)>4) drag.moved=true; let l=drag.l+dx,t=drag.t+dy; const r=mini.getBoundingClientRect(),ml=Math.max(0,window.innerWidth-r.width),mt=Math.max(0,window.innerHeight-r.height-60); l=Math.min(Math.max(0,l),ml); t=Math.min(Math.max(0,t),mt); mini.style.left=l+"px"; mini.style.top=t+"px"; mini.style.right="auto"; mini.style.bottom="auto"; });
mini.addEventListener("pointerup",e=>{ if(!drag.on||e.pointerId!==drag.id) return; mini.releasePointerCapture(e.pointerId); const moved=drag.moved; drag.on=false; if(!moved) miniUp(true); });
mini.addEventListener("pointercancel",()=>{ drag.on=false; });

new IntersectionObserver(es=>{ if(es[0].isIntersecting) loadMore(); },{rootMargin:"200px"}).observe(sentinel);

(async()=>{
  if(!(await waitNova())){ feedEmpty.hidden=false; feedEmpty.textContent="Unable to start video feed."; return; }
  try{ me=await window.NOVA.getUser(); }catch{ me=null; }
  await hydrateProfile();
  wire();
  history.replaceState({mode:"feed"},"",location.href);
  if(params.get("create")==="1") openUpload();
  await ensureFocus();
  await loadMore();
})();

function go(p){ location.href=p; }
</script>
</body>
</html>

