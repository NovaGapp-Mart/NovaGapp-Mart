<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Subscription | NOVAGAPP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="public-config.js"></script>
<script src="global.js"></script>

<style>
:root{
  --orange:#ff7a00;
  --bg:#0d0f14;
  --card:#151925;
  --muted:#9aa0a6;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:var(--bg);
  color:#fff;
}
.header{
  background:var(--orange);
  padding:16px 18px;
  font-size:20px;
  font-weight:900;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
}
.plan{
  background:var(--card);
  border-radius:16px;
  padding:22px;
  box-shadow:0 15px 40px rgba(0,0,0,.45);
  position:relative;
}
.plan h3{margin:0 0 6px}
.sub{color:var(--muted);font-size:13px;margin-bottom:8px}
.price{font-size:32px;font-weight:900;margin-bottom:10px}
ul{padding-left:18px;line-height:1.8}
button{
  width:100%;
  padding:14px;
  margin-top:16px;
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:900;
  cursor:pointer;
}
.buy{background:var(--orange);color:#000}
.current{background:#333;color:#aaa}
.enterprise{
  border:2px solid var(--orange);
  background:linear-gradient(180deg,#1a1208,#151925);
}
.badge{
  position:absolute;
  top:-12px;
  right:-12px;
  background:var(--orange);
  color:#000;
  padding:6px 12px;
  border-radius:10px;
  font-size:12px;
  font-weight:900;
}
.footer-note{
  text-align:center;
  color:var(--muted);
  font-size:12px;
  margin:20px 0 30px;
}
.eligibility-note{
  margin-top:10px;
  padding:8px 10px;
  border-radius:10px;
  background:#1f2533;
  color:#c7ccd4;
  font-size:12px;
  line-height:1.4;
}
.eligibility-note.ok{
  background:#10301e;
  color:#8ef2bc;
}
.buy[disabled]{
  background:#2f3440;
  color:#9fa5b0;
  cursor:not-allowed;
}
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9977276800228616"
     crossorigin="anonymous"></script>
</head>

<body>

<div class="header">Plans</div>

<div class="container">

<div class="plan" id="plan-free" data-plan="FREE">
  <h3>FREE</h3>
  <div class="sub">Default plan</div>
  <div class="price"><span class="money" data-money="0" data-currency="INR">?0</span></div>
  <ul>
    <li>1-to-1 chat</li>
    <li>Private feed</li>
    <li>Data ownership</li>
  </ul>
  <button class="current" disabled>Default</button>
</div>

<div class="plan" id="plan-plus" data-plan="PLUS">
  <h3>PLUS</h3>
  <div class="sub">Personal power</div>
  <div class="price"><span class="money" data-money="99" data-currency="INR">?99</span> / month</div>
  <ul>
    <li>AI assistant</li>
    <li>Guaranteed reach</li>
    <li>Locked posts</li>
  </ul>
  <button class="buy" data-plan="PLUS" onclick="pay(99,'PLUS','INR')">Upgrade</button>
</div>

<div class="plan" id="plan-creator" data-plan="CREATOR">
  <h3>CREATOR</h3>
  <div class="sub">Earn from followers</div>
  <div class="price"><span class="money" data-money="299" data-currency="INR">?299</span> / month</div>
  <ul>
    <li>Monetization</li>
    <li>Analytics</li>
    <li>Verified badge</li>
  </ul>
  <button class="buy" data-plan="CREATOR" id="creatorUpgradeBtn" onclick="pay(299,'CREATOR','INR')">Upgrade</button>
  <div class="eligibility-note" id="creatorEligibilityNote">
    Applicable if followers are more than 5,000.
  </div>
</div>

<div class="plan enterprise" id="plan-business" data-plan="BUSINESS">
  <div class="badge">RECOMMENDED</div>
  <h3>BUSINESS</h3>
  <div class="sub">For brands</div>
  <div class="price"><span class="money" data-money="999" data-currency="INR">?999</span> / month</div>
  <ul>
    <li>AI auto-reply</li>
    <li>Product catalog</li>
    <li>Payments</li>
    <li>Staff roles</li>
  </ul>
  <button class="buy" data-plan="BUSINESS" onclick="pay(999,'BUSINESS','INR')">Upgrade</button>
</div>

</div>

<div class="footer-note">
  Payments powered by Razorpay</div>

<script>
let razorpayKeyId = String(window.NOVA_PUBLIC_CONFIG?.razorpayKeyId || "").trim();
const supa = window.novaCreateSupabaseClient();
if(!supa){
  alert("Supabase connection unavailable. Please refresh.");
  location.href = "login.html";
  throw new Error("supabase_client_unavailable");
}

let currentUser = null;
let activePlan = "FREE";
let paymentBusy = false;
const creatorUpgradeBtn = document.getElementById("creatorUpgradeBtn");
const creatorEligibilityNote = document.getElementById("creatorEligibilityNote");
const CREATOR_MIN_FOLLOWERS = 5000;
let creatorFollowerCount = 0;
let creatorEligible = false;
let creatorEligibilityStatus = "checking";

function normalizeMobilePlan(planInput){
  const raw = String(planInput || "").trim().toUpperCase();
  const digits = raw.replace(/[^0-9]/g, "");
  if(
    raw === "BUSINESS" ||
    raw === "ENTERPRISE" ||
    raw === "BUSINESS_999" ||
    raw === "ENTERPRISE_4000" ||
    digits === "4000"
  ){
    return "BUSINESS";
  }
  if(
    raw === "CREATOR" ||
    raw === "CREATOR_299"
  ){
    return "CREATOR";
  }
  if(
    raw === "PLUS" ||
    raw === "PRO" ||
    raw === "PLUS_99" ||
    raw === "PRO_40" ||
    digits === "40"
  ){
    return "PLUS";
  }
  return "FREE";
}

function getBackendPlanCode(planInput){
  const normalized = normalizeMobilePlan(planInput);
  if(normalized === "BUSINESS") return "4000";
  if(normalized === "PLUS" || normalized === "CREATOR") return "40";
  return "free";
}

function buildApiBases(){
  const out = [];
  const push = (raw) => {
    const value = String(raw || "").trim().replace(/\/+$/g, "");
    if(!value) return;
    if(!/^https?:\/\//i.test(value)) return;
    if(!out.includes(value)) out.push(value);
  };
  try{
    push(window.CONTEST_API_BASE);
    push(window.API_BASE);
    push(localStorage.getItem("contest_api_base"));
    push(localStorage.getItem("api_base"));
    push(sessionStorage.getItem("contest_api_base"));
    push(sessionStorage.getItem("api_base"));
  }catch(_){ }
  if(/^https?:\/\//i.test(location.origin || "")) push(location.origin);
  push("https://novagapp-mart.onrender.com");
  return out;
}

async function callAutomationApi(path, options){
  const req = options || {};
  const method = req.method || "GET";
  const body = req.body;
  const candidates = [""].concat(buildApiBases());
  for(const base of candidates){
    const url = `${base}${path}`;
    try{
      const res = await fetch(url, {
        method,
        headers: body ? { "Content-Type":"application/json" } : undefined,
        body: body ? JSON.stringify(body) : undefined,
        cache: "no-store"
      });
      const payload = await res.json().catch(() => null);
      if(res.ok && payload){
        return payload;
      }
    }catch(_){ }
  }
  return null;
}

function extractMissingColumnName(error){
  const text = `${error?.message || ""} ${error?.details || ""}`;
  const pgMatch = text.match(/column\s+\"?([a-zA-Z0-9_.]+)\"?\s+does not exist/i);
  if(pgMatch && pgMatch[1]){
    return String(pgMatch[1]).split(".").pop().toLowerCase();
  }
  const quotedMatch = text.match(/'([a-zA-Z0-9_]+)'/);
  if(quotedMatch && quotedMatch[1]){
    return String(quotedMatch[1]).toLowerCase();
  }
  return "";
}

function formatCount(value){
  return new Intl.NumberFormat("en-US").format(Math.max(0, Number(value) || 0));
}

function setCreatorEligibilityNote(status, followers, eligible){
  if(!creatorEligibilityNote) return;
  const countText = formatCount(followers);
  creatorEligibilityNote.classList.toggle("ok", !!eligible && status === "ready");

  if(status === "checking"){
    creatorEligibilityNote.textContent = "Checking creator eligibility...";
    return;
  }
  if(status === "error"){
    creatorEligibilityNote.textContent = "Applicable if followers are more than 5,000. Unable to verify right now.";
    return;
  }
  if(eligible){
    creatorEligibilityNote.textContent = `Eligible: ${countText} followers. Creator plan is available.`;
  }else{
    creatorEligibilityNote.textContent = `Applicable if followers are more than 5,000. Your followers: ${countText}.`;
  }
}

function missingColumnError(error){
  const msg = String(error?.message || "").toLowerCase();
  const details = String(error?.details || "").toLowerCase();
  const all = `${msg} ${details}`;
  return all.includes("column") && all.includes("does not exist");
}

function convertPlanAmountToInr(amount, currency){
  const baseAmount = Number(amount || 0);
  if(!Number.isFinite(baseAmount) || baseAmount <= 0){
    throw new Error("Invalid plan amount.");
  }
  const baseCurrency = String(currency || "INR").trim().toUpperCase() || "INR";
  if(baseCurrency === "INR"){
    return Math.round(baseAmount * 100) / 100;
  }
  if(typeof window.convertCurrency !== "function"){
    throw new Error("Currency conversion is unavailable.");
  }
  const converted = Number(window.convertCurrency(baseAmount, baseCurrency, "INR"));
  if(!Number.isFinite(converted) || converted <= 0){
    throw new Error("Unable to convert plan amount to INR.");
  }
  return Math.round(converted * 100) / 100;
}

async function loadPlan(){
  const automated = await callAutomationApi(`/api/subscription/status?user_id=${encodeURIComponent(currentUser.id)}`, { method:"GET" });
  const automatedPlan = normalizeMobilePlan(automated?.subscription?.plan || "");
  if(automated?.ok && automatedPlan){
    activePlan = automatedPlan;
    try{
      localStorage.setItem("userPlan", getBackendPlanCode(activePlan));
    }catch(_){ }
    return;
  }

  let query = supa
    .from("subscription")
    .select("plan")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending:false })
    .limit(1)
    .maybeSingle();
  let { data, error } = await query;
  if(error && missingColumnError(error)){
    query = supa
      .from("subscription")
      .select("plan")
      .eq("user_id", currentUser.id)
      .limit(1)
      .maybeSingle();
    ({ data, error } = await query);
  }
  if(error){
    console.error("subscription_load_plan_failed", error);
    return;
  }
  if(data?.plan){
    activePlan = normalizeMobilePlan(data.plan);
    try{
      localStorage.setItem("userPlan", getBackendPlanCode(activePlan));
    }catch(_){ }
  }
}

function markCurrent(){
  document.querySelectorAll(".plan .buy[data-plan]").forEach(btn => {
    const btnPlan = String(btn.getAttribute("data-plan") || "").toUpperCase();
    if(!btnPlan) return;

    btn.classList.remove("current");
    btn.classList.add("buy");
    btn.textContent = "Upgrade";
    btn.disabled = false;

    if(btnPlan === activePlan){
      btn.textContent = "Current";
      btn.classList.add("current");
      btn.disabled = true;
      return;
    }
    if(btnPlan === "CREATOR"){
      if(creatorEligibilityStatus === "checking"){
        btn.textContent = "Checking...";
        btn.disabled = true;
        return;
      }
      if(creatorEligibilityStatus === "error" || !creatorEligible){
        btn.textContent = "Need 5,000+ followers";
        btn.disabled = true;
        return;
      }
    }
    if(paymentBusy){
      btn.disabled = true;
    }
  });
}

function setPaymentButtonsBusy(state){
  paymentBusy = !!state;
  markCurrent();
}

async function loadRazorpayConfig(){
  try{
    const res = await fetch("/api/payment/config", { cache:"no-store" });
    const payload = await res.json().catch(() => null);
    if(res.ok && payload?.ok && payload?.ready && payload?.key_id){
      razorpayKeyId = String(payload.key_id || "").trim();
      return true;
    }
  }catch(_){ }
  return !!razorpayKeyId;
}

async function refreshCreatorEligibility(){
  if(!currentUser) return;
  if(!creatorUpgradeBtn || !creatorEligibilityNote) return;

  creatorEligibilityStatus = "checking";
  creatorFollowerCount = 0;
  creatorEligible = false;
  setCreatorEligibilityNote("checking", 0, false);
  markCurrent();

  try{
    const { count, error } = await supa
      .from("follows")
      .select("follower_id", { count:"exact", head:true })
      .eq("following_id", currentUser.id);
    if(error) throw error;

    creatorFollowerCount = Number(count || 0);
    creatorEligible = creatorFollowerCount >= CREATOR_MIN_FOLLOWERS;
    creatorEligibilityStatus = "ready";
    setCreatorEligibilityNote("ready", creatorFollowerCount, creatorEligible);
  }catch(err){
    creatorFollowerCount = 0;
    creatorEligible = false;
    creatorEligibilityStatus = "error";
    setCreatorEligibilityNote("error", 0, false);
    console.error("creator eligibility error", err);
  }

  markCurrent();
}

async function createPaymentOrder(amountInr, plan, baseAmount, baseCurrency){
  const amountPaise = Math.round(Number(amountInr || 0) * 100);
  const cleanPlan = String(plan || "FREE").toUpperCase();
  const receipt = `msub_${cleanPlan.toLowerCase()}_${Date.now()}`;
  const name = String(
    currentUser?.user_metadata?.full_name ||
    currentUser?.user_metadata?.name ||
    currentUser?.email ||
    "User"
  );

  const res = await fetch("/api/payment/razorpay/order", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({
      amount_paise: amountPaise,
      currency: "INR",
      order_id: receipt,
      receipt,
      user_id: currentUser?.id || "",
      user_name: name,
      notes: {
        plan: cleanPlan,
        source: "m_subscription_page",
        base_amount: String(Number(baseAmount || 0)),
        base_currency: String(baseCurrency || "INR").toUpperCase()
      }
    })
  });
  const payload = await res.json().catch(() => null);
  if(!res.ok || !payload?.ok || !payload?.order?.razorpay_order_id){
    const message = payload?.message || payload?.error || "Unable to create payment order.";
    throw new Error(String(message));
  }
  return payload.order;
}

async function verifyPayment(razorpayResponse){
  const res = await fetch("/api/payment/razorpay/verify", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      razorpay_order_id: razorpayResponse?.razorpay_order_id || "",
      razorpay_payment_id: razorpayResponse?.razorpay_payment_id || "",
      razorpay_signature: razorpayResponse?.razorpay_signature || ""
    })
  });
  const payload = await res.json().catch(() => null);
  if(!res.ok || !payload?.ok || !payload?.verified){
    const message = payload?.message || payload?.error || "Payment verification failed.";
    throw new Error(String(message));
  }
  return payload;
}

async function activateSubscriptionAutomation(plan, amountInr, verifyPayload){
  const payload = await callAutomationApi("/api/subscription/activate", {
    method: "POST",
    body: {
      user_id: currentUser.id,
      plan: getBackendPlanCode(plan),
      source: "m_subscription_checkout",
      amount_paise: Math.round(Number(amountInr || 0) * 100),
      currency: "INR",
      payment_id: String(verifyPayload?.razorpay_payment_id || ""),
      order_id: String(verifyPayload?.razorpay_order_id || ""),
      metadata: {
        ui_plan: normalizeMobilePlan(plan)
      }
    }
  });
  if(payload?.ok){
    const normalized = normalizeMobilePlan(payload?.subscription?.plan || plan);
    activePlan = normalized;
    try{
      localStorage.setItem("userPlan", getBackendPlanCode(normalized));
    }catch(_){ }
    return normalized;
  }

  const status = await callAutomationApi(`/api/subscription/status?user_id=${encodeURIComponent(currentUser.id)}`, { method:"GET" });
  if(status?.ok && status?.subscription?.plan){
    const normalized = normalizeMobilePlan(status.subscription.plan);
    activePlan = normalized;
    try{
      localStorage.setItem("userPlan", getBackendPlanCode(normalized));
    }catch(_){ }
    return normalized;
  }

  throw new Error("subscription_activation_failed");
}

async function openCheckout(order, amountInr, plan){
  if(typeof window.Razorpay !== "function"){
    throw new Error("Razorpay SDK failed to load.");
  }
  return new Promise((resolve, reject) => {
    let settled = false;
    const finish = (fn, value) => {
      if(settled) return;
      settled = true;
      fn(value);
    };
    const rzp = new window.Razorpay({
      key: String(order?.key_id || razorpayKeyId || ""),
      amount: Number(order?.amount_paise || Math.round(amountInr * 100)),
      currency: "INR",
      order_id: String(order?.razorpay_order_id || ""),
      name: "NOVAGAPP",
      description: `${String(plan || "FREE").toUpperCase()} subscription`,
      theme: { color:"#ff7a00" },
      prefill: {
        email: String(currentUser?.email || ""),
        name: String(
          currentUser?.user_metadata?.full_name ||
          currentUser?.user_metadata?.name ||
          ""
        )
      },
      handler: function(response){
        finish(resolve, response || {});
      },
      modal: {
        ondismiss: function(){
          finish(reject, new Error("Payment cancelled."));
        }
      }
    });
    rzp.on("payment.failed", function(event){
      const desc = event?.error?.description || "Payment failed. Please try again.";
      finish(reject, new Error(String(desc)));
    });
    rzp.open();
  });
}

async function pay(amount, plan, currency){
  if(!currentUser){
    alert("Login required");
    location.href = "login.html";
    return;
  }
  const nextPlan = normalizeMobilePlan(plan);
  if(nextPlan === "CREATOR" && !creatorEligible){
    alert("Creator plan is applicable only for users with more than 5,000 followers.");
    return;
  }
  if(activePlan === nextPlan){
    alert("This plan is already active.");
    return;
  }
  if(paymentBusy){
    return;
  }

  setPaymentButtonsBusy(true);
  try{
    const ready = await loadRazorpayConfig();
    if(!ready || !String(razorpayKeyId || "").trim()){
      throw new Error("Razorpay is not configured on server.");
    }

    const baseAmount = Number(amount || 0);
    const baseCurrency = String(currency || "INR").trim().toUpperCase() || "INR";
    const amountInr = convertPlanAmountToInr(baseAmount, baseCurrency);
    const order = await createPaymentOrder(amountInr, nextPlan, baseAmount, baseCurrency);
    const response = await openCheckout(order, amountInr, nextPlan);
    const verified = await verifyPayment(response);
    const activatedPlan = await activateSubscriptionAutomation(nextPlan, amountInr, verified);

    activePlan = activatedPlan || nextPlan;
    markCurrent();
    alert("Plan activated");
    location.href = "m-account.html";
  }catch(err){
    const message = String(err?.message || "Payment failed. Please try again.");
    if(message !== "Payment cancelled."){
      alert(message);
    }
  }finally{
    setPaymentButtonsBusy(false);
    markCurrent();
  }
}

window.pay = pay;

(async function init(){
  const { data } = await supa.auth.getUser();
  if(!data?.user){
    alert("Login required");
    location.href = "login.html";
    return;
  }
  currentUser = data.user;
  await Promise.all([loadPlan(), refreshCreatorEligibility(), loadRazorpayConfig()]);
  markCurrent();
})();
</script>

</body>
</html>


